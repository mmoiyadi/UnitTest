stl.view.Links=function(a){this.REFRESH_DELAY_MS=500;this.ENDPOINT_HIDE_TIMEOUT_MS=250;$.extend(this,a);this.$container=a.container;this.$elts=$();this.$endpoints=$();this.$obstacleElts=$();this.nextLinkID=0;this.minPathDistanceFromObstacle=a.minPathDistanceFromObstacle||5;this.connectionsByEltID={};this.endpointsByID={};this.elementsByID={};this.connectionPathsByID={};this.linksByID={};this.pendingEndpointHides={};this.horizontalSegmentsInUseByY={};this.verticalSegmentsInUseByX={};this.arrowHeadIDsByColor={};this.visible=(a.visible!==false);this.spreadLinks=(a.spreadLinks!==false);if(a.elements){this.addElements(a.elements)}if(a.pathfindingStrategy==="NONE"){this.findRoute=this.getStraightLinePath}if(this.visible){this.refresh()}this.ready=true};$.extend(stl.view.Links.prototype,(function(){var a=5,d="rgb(200,200,200)",e="red",c=d3.svg.line().x(function(g){return g.x}).y(function(g){return g.y}).interpolate("linear"),b=10,f=500;return({addElements:function(g){var h=this;g.each(function(j,i){var l="link-"+String(h.nextLinkID++),k=$(i);k.data("linkable-element-id",l);h.elementsByID[l]=k});g.addClass("linkable-element");g.on("dragenter",this.onElementDragEnter.bind(this));g.on("dragover",this.onElementDragOver.bind(this));g.on("dragout",this.onElementDragLeave.bind(this));g.on("drop",this.onElementDrop.bind(this));g.on("mouseenter",this.onElementMouseEnter.bind(this));g.on("mouseleave",this.onElementMouseLeave.bind(this));this.$elts=this.$elts.add(g);this.triggerRefresh()},addObstacles:function(g){this.$obstacleElts=this.$obstacleElts.add(g);this.triggerRefresh()},addConnection:function(i,k,g){var j=i.data("linkable-element-id"),n=k.data("linkable-element-id"),m=this.getOrCreateConns(j),h=this.getOrCreateConns(n),l=this.getLinkID(j,n);if(m.outgoing.indexOf(n)===-1){m.outgoing.push(n)}if(h.incoming.indexOf(j)===-1){h.incoming.push(j)}this.linksByID[l]={from:i,to:k,color:g||null};this.triggerRefresh()},setLinkColor:function(h,k,g){var j=h.data("linkable-element-id"),m=k.data("linkable-element-id"),l=this.getLinkID(j,m),i=this.linksByID[l];if(i){i.color=g||null;this.triggerRefresh()}},setLinkZIndex:function(h,k,n){var j=h.data("linkable-element-id"),m=k.data("linkable-element-id"),l=this.getLinkID(j,m),i=this.linksByID[l],g=this.connectionPathsByID[l];if(i){i.zIndex=n||null;if(g){g.css("z-index",n)}else{this.triggerRefresh()}}},setAllLinkProperties:function(g,h){Object.keys(this.linksByID).forEach(function(j){var i=this.linksByID[j];if(i){i.color=g||null;i.zIndex=h||null}}.bind(this));this.triggerRefresh()},removeConnection:function(g,i){var h=g.data("linkable-element-id"),j=i.data("linkable-element-id");this.removeConnectionByIDs(h,j)},removeConnectionsForElement:function(k){var l=this,j=k.data("linkable-element-id"),h=this.getOrCreateConns(j);for(var g=h.incoming.length-1;g>=0;g--){l.removeConnectionByIDs(h.incoming[g],j)}for(var g=h.outgoing.length-1;g>=0;g--){l.removeConnectionByIDs(j,h.outgoing[g])}delete this.connectionsByEltID[j];if(this.ready){this.triggerRefresh()}},removeConnectionByIDs:function(i,m){var l=this.getOrCreateConns(i),g=this.getOrCreateConns(m),k=l.outgoing.indexOf(m),h=g.incoming.indexOf(i),j=this.getLinkID(i,m);if(k>-1){l.outgoing.splice(k,1)}if(h>-1){g.incoming.splice(h,1)}if(this.linksByID[j]){delete this.linksByID[j]}if(this.ready){this.triggerRefresh()}},removeElement:function(i){var h=i.data("linkable-element-id"),g=this.endpointsByID[h+"-out"],j=this.endpointsByID[h+"-in"];this.removeConnectionsForElement(i);if(g){g.remove()}if(j){j.remove()}delete this.elementsByID[h];this.$elts=this.$elts.not(i)},clearAll:function(){this.$elts=$();this.elementsByID={};this.connectionsByID={};this.connectionsByEltID={};this.connectionPathsByID={};this.linksByID={}},getOrCreateConns:function(h){var g=this.connectionsByEltID[h];if(!g){g={incoming:[],outgoing:[]};this.connectionsByEltID[h]=g}return g},getInterestingPoints:function(){var k=this.minPathDistanceFromObstacle,v=this.outEndpointXOffset||0;this.elementPositions=[];this.elementPositionsByTop={};this.elementPositionsByLeft={};this.interestingPoints=[];this.interestingPointsByX={};this.interestingPointsByY={};this.interestingYs=[];this.interestingXs=[];this.elementTops=[];this.elementLefts=[];this.pathEndpointsByElementID={};this.existsPointAtXY={};this.cachedPaths={};var m=this.$container.offset(),g=this.leftEdge||0,s=this.topEdge||0;m.left-=this.$container.scrollLeft();m.top-=this.$container.scrollTop();for(var n=0;n<this.$elts.length;n++){var w=this.$elts.eq(n);var r=w.offset();var h=w.width();var u=w.outerHeight();var p={left:r.left-m.left,top:r.top-m.top,right:r.left-m.left+h,bottom:r.top-m.top+u};this.elementPositions.push(p);if(!this.elementPositionsByTop[p.top]){this.elementPositionsByTop[p.top]=[];this.elementTops.push(p.top)}this.elementPositionsByTop[p.top].push(p);if(!this.elementPositionsByLeft[p.left]){this.elementPositionsByLeft[p.left]=[];this.elementLefts.push(p.left)}this.elementPositionsByLeft[p.left].push(p);if(p.top-k>s){this.addInterestingPoint(p.left-k,p.top-k);this.addInterestingPoint(p.left+h+k,p.top-k)}this.addInterestingPoint(p.left-k,p.top+u+k);this.addInterestingPoint(p.left+h+k,p.top+u+k);var t=u,o=w.data("link-target-selector");if(o!==undefined){t=w.find(o).height()}var l=p.top+(this.outEndpointYOffset||(t/2));var q=this.addInterestingPoint(p.left-k,l),j=this.addInterestingPoint(p.left+h+k+v,l);this.pathEndpointsByElementID[w.data("linkable-element-id")]={inPt:q,outPt:j}}for(var n=0;n<this.$obstacleElts.length;n++){var w=this.$obstacleElts.eq(n),r=w.offset(),h=w.width(),u=w.outerHeight(),p={left:r.left-m.left,top:r.top-m.top,right:r.left-m.left+h,bottom:r.top-m.top+u};this.elementPositions.push(p);if(!this.elementPositionsByTop[p.top]){this.elementPositionsByTop[p.top]=[];this.elementTops.push(p.top)}this.elementPositionsByTop[p.top].push(p);if(!this.elementPositionsByLeft[p.left]){this.elementPositionsByLeft[p.left]=[];this.elementLefts.push(p.left)}this.elementPositionsByLeft[p.left].push(p);this.addInterestingPoint(p.left-k,p.top-k);this.addInterestingPoint(p.left+h+k,p.top-k);this.addInterestingPoint(p.left-k,p.top+u+k);this.addInterestingPoint(p.left+h+k,p.top+u+k)}this.elementTops.sort(this.sortNumbers);this.elementLefts.sort(this.sortNumbers);this.interestingYs.sort(this.sortNumbers);this.interestingXs.sort(this.sortNumbers)},sortNumbers:function(h,g){return h-g},addInterestingPoint:function(g,k){var i={x:g,y:k,connectedPts:[],id:String(g)+","+String(k)};this.interestingPoints.push(i);var h=this.interestingPointsByY[k];if(!h){h=this.interestingPointsByY[k]=[];this.interestingYs.push(k)}h.push(i);var j=this.interestingPointsByX[g];if(!j){j=this.interestingPointsByX[g]=[];this.interestingXs.push(g);this.existsPointAtXY[g]={}}this.existsPointAtXY[g][k]=true;j.push(i);return i},testRenderInterestingPoints:function(){for(var g=0;g<this.interestingPoints.length;g++){var h=$('<div style="position: absolute; width: 5px; height: 5px; background: red"></div>').css({top:this.interestingPoints[g].y-2,left:this.interestingPoints[g].x-2});this.$container.append(h)}},constructVisibilityGraph:function(){this.getInterestingPoints();var r=[],s=0,h=0,q=[],g=[];for(var o=0;o<this.interestingYs.length;o++){var u=this.interestingYs[o];w=this.interestingPointsByY[u];for(var t=0;t<this.interestingXs.length;t++){var v=this.interestingXs[t];if(!this.existsPointAtXY[v][u]){this.addInterestingPoint(v,u)}}for(var m=r.length-1;m>=0;m--){if(u>r[m].bottom){r.splice(m,1)}}for(var m=s;m<this.elementTops.length;m++){if(this.elementTops[m]>u){s=m;break}else{var p=this.elementPositionsByTop[this.elementTops[m]];for(var l=0;l<p.length;l++){var n=p[l];if(n.bottom>=u){r.push(n)}}}}this.populateConnectedPointsOnXOptimized(w,r)}r=[];for(var o=0;o<this.interestingXs.length;o++){var v=this.interestingXs[o],w=this.interestingPointsByX[v];for(var m=r.length-1;m>=0;m--){if(v>r[m].right){r.splice(m,1)}}for(var m=h;m<this.elementLefts.length;m++){if(this.elementLefts[m]>v){h=m;break}else{var p=this.elementPositionsByLeft[this.elementLefts[m]];for(var l=0;l<p.length;l++){var n=p[l];if(n.right>=v){r.push(n)}}}}this.populateConnectedPointsOnYOptimized(w,r)}},populateConnectedPointsOnXOptimized:function(s,q){for(var o=0;o<s.length;o++){var r=s[o];for(var h=0;h<q.length;h++){var p=q[h];if(p.left<=r.x&&p.right>=r.x){r.blocked=true;break}}}for(var o=0;o<s.length;o++){for(var l=o+1;l<s.length;l++){var n=true,g=s[o],i=s[l];if(g.blocked||i.blocked){break}if(g.x>i.x){g=i;i=s[o]}for(var h=0;h<q.length;h++){var p=q[h];if(p.left>=g.x&&p.left<=i.x){n=false;break}else{if(p.right>=g.x&&p.right<=i.x){n=false;break}}}if(n){g.connectedPts.push(i);i.connectedPts.push(g)}}}},populateConnectedPointsOnX:function(r,q){for(var o=0;o<r.length;o++){for(var l=o+1;l<r.length;l++){var n=true,g=r[o],i=r[l];if(g.blocked||i.blocked){continue}if(g.x>i.x){g=i;i=r[o]}for(var h=0;h<q.length;h++){var p=q[h];if(p.left>=g.x&&p.left<=i.x){if(p.right>=i.x){i.blocked=true}n=false;break}else{if(p.right>=g.x&&p.right<=i.x){if(p.left<=g.x){g.blocked=true}n=false;break}}}if(n){g.connectedPts.push(i);i.connectedPts.push(g)}}}},populateConnectedPointsOnYOptimized:function(s,q){for(var n=0;n<s.length;n++){var r=s[n];for(var h=0;h<q.length;h++){var p=q[h];if(p.top<=r.y&&p.bottom>=r.y){r.blocked=true;break}}}for(var n=0;n<s.length;n++){for(var i=n+1;i<s.length;i++){var l=true,o=s[n],g=s[i];if(o.blocked||g.blocked){break}if(o.y>g.y){o=g;g=s[n]}for(var h=0;h<q.length;h++){var p=q[h];if(p.top>=o.y&&p.top<=g.y){l=false;break}else{if(p.bottom>=o.y&&p.bottom<=g.y){l=false;break}}}if(l){o.connectedPts.push(g);g.connectedPts.push(o)}}}},populateConnectedPointsOnY:function(r,q){for(var n=0;n<r.length;n++){for(var i=n+1;i<r.length;i++){var l=true,p=r[n],g=r[i];if(p.blocked||g.blocked){continue}if(p.y>g.y){p=g;g=r[n]}for(var h=0;h<q.length;h++){var o=q[h];if(o.top>=p.y&&o.top<=g.y){if(o.bottom>=g.y){g.blocked=true}l=false;break}else{if(o.bottom>=p.y&&o.bottom<=g.y){if(o.top<=p.y){p.blocked=true}l=false;break}}}if(l){p.connectedPts.push(g);g.connectedPts.push(p)}}}},findRoute:function(p,y){var C=this.cachedPaths[p.id];if(C){var j=C[y.id];if(j){return j}}var u=[],g={},v={},q=false,A={prev:null,pt:p,cost:0,totalCost:0,estRemainingCost:this.manhattanDistance(p.x,p.y,y.x,y.y),bends:0,distance:0,inDir:null},l=0;u.push(A);g[A.pt.id]=A;while(!q){var m=u.pop();if(!m){if(this.debug){console.log("Couldn't find path between points",p,y,this)}return}l++;if(l>f){if(this.debug){console.log("Aborting path search at",f,"iterations")}return}delete g[m.pt.id];if(m.pt===y){var s=[];var o=m;while(o){s.push({x:o.pt.x,y:o.pt.y});o=o.prev}q=true;s.reverse();if(!C){C=this.cachedPaths[p.id]={}}C[y.id]=s;s.distance=m.distance;return s}for(var w=0;w<m.pt.connectedPts.length;w++){var n=m.pt.connectedPts[w];if(v[n.id]){continue}var h=m.distance+this.manhattanDistance(m.pt.x,m.pt.y,n.x,n.y),B=m.bends,t="r";if(n.x===m.pt.x){t=(n.y>m.pt.y?"d":"u")}else{if(n.x<m.pt.x){t="l"}}if(t!==m.inDir){B++}var z=h+B,r=this.manhattanDistance(n.x,n.y,y.x,y.y),x=z+(2*r);var k=g[n.id];if(!k){k={pt:n};u.push(k);g[n.id]=k}if(typeof k.totalCost==="undefined"||(x<k.totalCost)){k.cost=z;k.totalCost=x;k.bends=B;k.inDir=t;k.estRemainingCost=r;k.prev=m;k.distance=h}}u.sort(function(D,i){return(i.totalCost-D.totalCost)});v[m.pt.id]=true}},getStraightLinePath:function(h,g){return[{x:h.x,y:h.y},{x:g.x,y:g.y}]},manhattanDistance:function(h,j,g,i){return(Math.abs(g-h)+Math.abs(i-j))},triggerRefresh:function(){if(stl.app.getCurrentViewId()!==TABLE_VIEW_ID){if(!this.visible){this.refreshOnNextShow=true;return}if(this.refreshTimeout){clearTimeout(this.refreshTimeout)}if(!this.refreshDelegate){this.refreshDelegate=this.refresh.bind(this)}this.refreshTimeout=setTimeout(this.refreshDelegate,this.REFRESH_DELAY_MS)}},showRefreshLinksNotifier:function(){if(stl.app.getCurrentViewId()!==TABLE_VIEW_ID&&this.visible){showToolbarNotifier(DRAWING_DEPENDENCIES+PLEASE_WAIT)}},beforeLinkRefresh:function(g,h){h.apply(g,[hideToolbarNotifier])},refresh:function(){this.arrowHeadIDsByColor={};var n=[];this.horizontalSegmentsInUseByY={};this.verticalSegmentsInUseByX={};this.constructVisibilityGraph();this.$container.find("svg.link").remove();this.$endpoints=$();var j=(document.all&&!window.atob);if(j&&!this.addedIE9Support&&!this.$container.data("linkview-ie9-support-added")){this.$container.on("mousemove",function(i){if(window.event.button===1&&$(i.target).hasClass("link-endpoint")){i.target.dragDrop()}});this.$container.data("linkview-ie9-support-added",true);this.addedIE9Support=true}for(var k=0;k<this.$elts.length;k++){var o=this.$elts.eq(k),h=o.data("linkable-element-id"),p=this.getOrCreateConns(h),m=this.endpointsByID[h+"-out"],g=this.endpointsByID[h+"-in"];if(!m){m=this.createEndpoint(o,"out",j)}if(p.incoming.length>0){if(!g){g=this.createEndpoint(o,"in",j)}}else{if(g){g.remove();g=null}}this.positionEndpoints(o,g,m);n.push({elt:o,inEndpoint:g,outEndpoint:m,connections:p})}for(var k=0;k<n.length;k++){var l=n[k];if(this.isElementRowVisible(l.elt)){this.redrawOutgoingConnections(l.elt,l.connections)}}setTimeout(function(){$(this).trigger("refreshcomplete")}.bind(this),0);hideToolbarNotifier()},isElementRowVisible:function(g){var i=true;if(g){var h=g.closest(".matrix-view-row");if(h){var j=h.css("display");if(j=="none"){i=false}}}return i},positionEndpoints:function(h,m,g){var l=h.offset(),k=this.$container.offset(),j=l.left+this.$container.scrollLeft()-k.left+(this.outEndpointXOffset||0),i=l.top+this.$container.scrollTop()-k.top+(this.outEndpointYOffset||(h.height()/2));g.css({left:j+h.width()+1,top:i});if(m){m.css({left:j,top:i})}},redrawOutgoingConnections:function(l,j){var k=l.data("linkable-element-id");if(!j){j=this.getOrCreateConns(k)}for(var h=0;h<j.outgoing.length;h++){var g=j.outgoing[h];var n=this.getLinkID(k,g),m=this.connectionPathsByID[n];if(m){m.remove()}if(this.isElementRowVisible(this.elementsByID[g])){this.connectionPathsByID[n]=this.findAndDrawRoute(l,this.elementsByID[g],true)}}},drawRoute:function(l,i,m){var h=d3.select(this.$container[0]).append("svg").attr("class","link").attr("width","1").attr("height","1");if(!i){i=d}var j=this.getOrCreateArrowMarker(h,i),k=this.getOrCreateArrowMarker(h,e);var g=h.append("path").attr("class","link-path").attr("d",c(l)).attr("stroke",i).attr("stroke-width",2).attr("fill","none").attr("marker-end","url(#"+j+")").on("mouseenter",function(){d3.select(this).attr("marker-end","url(#"+k+")").transition().duration(200).style("stroke",e)}).on("mouseleave",function(){d3.select(this).attr("marker-end","url(#"+j+")").transition().duration(200).style("stroke",i)});if(m){h.style("z-index",m)}return $(h[0])},getOrCreateArrowMarker:function(j,h,g){var i=this.arrowHeadIDsByColor[h];if(!i||g){i=this.createArrowMarker(j,h);if(!g){this.arrowHeadIDsByColor[h]=i}}return i},createArrowMarker:function(i,h){this.lastArrowMarkerID=(this.lastArrowMarkerID||0)+1;var j="arrow-"+String(this.lastArrowMarkerID);var g=i.append("svg:defs").append("svg:marker").attr("id",j).attr("viewBox","0 0 8 8").attr("refX",7).attr("refY",4).attr("markerUnits","strokeWidth").attr("fill",h).attr("stroke","none").attr("markerWidth",5).attr("markerHeight",3).attr("orient","auto").append("svg:path").attr("d","M 0 0 L 8 4 L 0 8 z");return j},createEndpoint:function(i,h,k){var g=i.data("linkable-element-id"),j=(k?$('<a href="javascript:;" draggable="true" class="link-endpoint"></a>'):$('<div class="link-endpoint" draggable="true"></div>'));j.addClass("link-endpoint-"+h);j.data({"endpoint-element-id":g,"endpoint-type":h});j.on("dragstart",this.onEndpointDragStart.bind(this));j.on("dragend",this.onEndpointDragEnd.bind(this));j.on("mouseenter",this.onEndpointMouseEnter.bind(this));j.on("mouseleave",this.onEndpointMouseLeave.bind(this));j.on("click",this.onEndpointClick.bind(this));this.$container.append(j);this.endpointsByID[g+"-"+h]=j;j.hide();return j},onEndpointDragStart:function(g){if(this.readOnly){g.preventDefault();return false}this.draggingEndpoint=true;var h=$(g.target),i=h.offset();g.originalEvent.dataTransfer.setData("Text","");this.dragContainerOffset=this.$container.offset();this.dragStartPos=i;this.dragStartElementID=h.data("endpoint-element-id");this.dragRoutingStartPt=this.pathEndpointsByElementID[this.dragStartElementID][h.data("endpoint-type")+"Pt"];this.dragStartingEndpointPos=h.offset();g.stopPropagation()},onEndpointClick:function(o){if(this.readOnly){return}var m=$(o.target).closest(".link-endpoint"),j=m.offset(),n=m.data("endpoint-element-id"),h=this.connectionsByEltID[n].outgoing;if(!this.endpointPopup){this.endpointPopup=$('<div class="tool-popup below"></div>');$(document.body).append(this.endpointPopup)}this.endpointPopup.data("link-source-id",n).empty();for(var k=0;k<h.length;k++){var l=h[k];var p=this.elementsByID[l];if(p.hasClass("ms-content-wrap")){var g=p.parent().data("model").name}else{var g=p.data("model").name}this.endpointPopup.append($("<div></div>").text("Remove link to "+g).data({"delete-link-source-id":n,"delete-link-target-id":l}))}this.endpointPopup.find("div").on("click",this.onDeleteLinkClick.bind(this));this.endpointPopup.find("div").on("mouseenter",this.onMouseHover.bind(this));this.endpointPopup.find("div").on("mouseleave",this.onMouseLeave.bind(this));this.endpointPopup.css({top:j.top+10,left:j.left-(this.endpointPopup.width()/2)});this.endpointPopup.show();o.stopPropagation();o.preventDefault()},onMouseHover:function(g){if(this.readOnly){return}var k=$(g.target),j=k.data("delete-link-target-id"),h=k.data("delete-link-source-id"),i=this.linksByID[this.getLinkID(h,j)];i.oldColor=i.color;i.color="orange";this.triggerRefresh()},onMouseLeave:function(g){if(this.readOnly){return}var k=$(g.target),j=k.data("delete-link-target-id"),h=k.data("delete-link-source-id"),i=this.linksByID[this.getLinkID(h,j)];if(i){if(i.oldColor!=null){i.color=i.oldColor}else{i.color=null}this.triggerRefresh()}},onDeleteLinkClick:function(g){if(this.readOnly){return}var k=$(g.target),j=k.data("delete-link-target-id"),h=k.data("delete-link-source-id"),i=this.linksByID[this.getLinkID(h,j)];this.endpointPopup.hide();if(i){if(i.to.closest(".milestone").length>0&&i.to.closest(".milestone").data("model").taskType=="PE"){if(this.getOrCreateConns(j).incoming.length==1){PPI_Notifier.alert(CANT_REMOVE_LINK,LINK_ERROR);return}}this.removeConnectionByIDs(h,j);$(this).trigger("linkremove",i)}},setVisible:function(g){this.visible=g;if(g){if(this.refreshOnNextShow){$(this).one("refreshcomplete",function(){this.$container.removeClass("links-hidden")}.bind(this));this.showRefreshLinksNotifier();this.triggerRefresh();delete this.refreshOnNextShow}else{this.$container.removeClass("links-hidden")}}else{this.$container.addClass("links-hidden");this.$endpoints.hide()}},onEndpointDragEnd:function(g){setTimeout(function(){this.draggingEndpoint=false}.bind(this),0)},onElementDragEnter:function(g){if(!this.draggingEndpoint){return}var i=$(g.target).closest(".linkable-element"),h=i.data("linkable-element-id"),j=this.getLinkID(this.dragStartElementID,h);if(this.linksByID[j]){return}g.preventDefault();if(!this.elementsByID[this.dragStartElementID].is(i)&&i.hasClass("linkable-element")){this.lastDragLine=this.findAndDrawRoute(this.elementsByID[this.dragStartElementID],i,false);i.addClass("link-drop-target")}},findAndDrawRoute:function(r,g,k){var o=r.data("linkable-element-id"),l=g.data("linkable-element-id"),h=this.pathEndpointsByElementID[o]["outPt"],j=this.pathEndpointsByElementID[l]["inPt"],p=this.linksByID[this.getLinkID(o,l)],m=this.manhattanDistance(h.x,h.y,j.x,j.y);if(m<b||h.blocked||j.blocked){return}var q=this.findRoute(h,j);if(!q){return}q.splice(0,0,{x:h.x-this.minPathDistanceFromObstacle,y:h.y});q.push({x:j.x+this.minPathDistanceFromObstacle,y:j.y});if(this.spreadLinks&&!q.adjusted){this.adjustPath(q,k);q.adjusted=true}var i=p?p.color:null,n=p?p.zIndex:null;if(k){return this.drawRoute(q,i,n)}else{return true}},printPath:function(g){return g.map(function(h){return"("+h.x+", "+h.y+")"}).join(", ")},adjustPath:function(v,m){var n=this,q=[],s=false,j=[],p=1;while(p<v.length-2){var w=v[p],u=v[p+1],r=(u.y===w.y),t=(r?"y":"x"),o=(r?"x":"y"),l=w[t];while(p+2<(v.length-1)&&v[p+2][t]===l){v.splice(p+1,1);u=v[p+1]}var i=1,h=l,g=w[o],k=u[o];while(this.segmentCollides(r,h,g,k)){h+=(i%2||-1)*i*a;i++}w[t]=h;u[t]=h;if(m){this.rememberSegment(r,h,g,k)}if(s&&!r&&(u.y-w.y>20)){v.splice(p,0,{x:w.x-20,y:w.y});w.y+=20;p++}s=(r&&(u.x-w.x>20));p++}},rememberSegment:function(m,h,l,k){var g=(m?this.horizontalSegmentsInUseByY:this.verticalSegmentsInUseByX),j=g[h];if(!j){g[h]=j=[]}j.push({start:l,end:k})},segmentCollides:function(o,l,n,m){var j=(o?this.horizontalSegmentsInUseByY:this.verticalSegmentsInUseByX),p=j[l];if(!p){return false}for(var h=0;h<p.length;h++){var g=p[h];if((g.start>=n&&g.start<=m)||(g.end>=m&&g.end<=m)||(n>=g.start&&n<=g.end)){return true}}return false},onElementMouseEnter:function(h){if(this.readOnly||!this.visible){return}var j=$(h.target).closest(".linkable-element"),i=j.data("linkable-element-id");if(this.pendingEndpointHides[i]){if(this.elementsByID[i]){clearTimeout(this.pendingEndpointHides[i])}}var g=this.endpointsByID[i+"-out"];if(g){var k=this.elementsByID[i].hasClass("quick-task-edit")||this.elementsByID[i].parent().hasClass("quick-task-edit");if(this.elementsByID[i]&&!k){this.endpointsByID[i+"-out"].show()}}},onElementMouseLeave:function(g){if(this.readOnly){return}var i=$(g.target).closest(".linkable-element"),h=i.data("linkable-element-id");this.triggerEndpointHide(h,this.endpointsByID[h+"-out"])},onEndpointMouseEnter:function(g){if(this.readOnly){return}var h=$(g.target).data("endpoint-element-id");if(this.pendingEndpointHides[h]){clearTimeout(this.pendingEndpointHides[h])}},onEndpointMouseLeave:function(g){if(this.readOnly){return}var i=$(g.target),h=i.data("endpoint-element-id");this.triggerEndpointHide(h,i)},triggerEndpointHide:function(g,h){this.pendingEndpointHides[g]=setTimeout(function(){if(h){h.hide()}},this.ENDPOINT_HIDE_TIMEOUT_MS)},onElementDragLeave:function(g){if(!this.draggingEndpoint){return}var h=$(g.target);if(h.hasClass("linkable-element")){h.removeClass("link-drop-target");if(this.lastDragLine){$(this.lastDragLine[0]).remove()}}},onElementDragOver:function(g){if(!this.draggingEndpoint){return}g.preventDefault()},onElementDrop:function(g){if(!this.draggingEndpoint){return}g.preventDefault();var j=$(g.target).closest(".linkable-element");if(j.length===0){return}j.removeClass("link-drop-target");var h=j.data("linkable-element-id"),k=this.getLinkID(this.dragStartElementID,h);if(this.linksByID[k]){return}var i={from:this.elementsByID[this.dragStartElementID],to:this.elementsByID[h],valid:true,errors:[]};$(this).trigger("beforelinkadd",i);if(!i.valid){return}delete i.valid;this.addConnection(i.from,i.to);this.findAndDrawRoute(i.from,i.to,true);$(this).trigger("linkadd",i)},getLinkID:function(h,g){return h+"->"+g},setReadOnly:function(g){if(g===this.readOnly){return}this.readOnly=g},setOutEndpointOffsets:function(g){this.outEndpointYOffset=g.y;this.outEndpointXOffset=g.x},clearHighlights:function(){this.$elts.each(function(h,g){if($(g).hasClass("task-highlight")){$(g).removeClass("task-highlight");$(Ext.getCmp("timelineview").linksView.$elts[h]).removeClass("task-highlight")}})},isLinkInCriticalChain:function(h,i){var k=false;var j=h.data("model");if(j==undefined){j=h.parent().data("model")}var g=i.data("model");if(g==undefined){g=i.parent().data("model")}k=false;if((j.taskType=="buffer"||j.taskType=="normal"||j.taskType=="fullkit")&&(g.taskType=="buffer"||g.taskType=="normal"||g.taskType=="fullkit")){k=h.hasClass("isCCTask")&&i.hasClass("isCCTask")}else{if(j.taskType=="buffer"||j.taskType=="normal"||j.taskType=="fullkit"){k=h.hasClass("isCCTask")&&i.parent().hasClass("isCCTask")}else{if(g.taskType=="buffer"||g.taskType=="normal"||g.taskType=="fullkit"){k=h.parent().hasClass("isCCTask")&&i.hasClass("isCCTask")}else{k=h.parent().hasClass("isCCTask")&&i.parent().hasClass("isCCTask")}}}return k}})})());(function(d){var b=d.event,a=b.special,c=a.dragout={current_elem:false,setup:function(g,f,e){d("body").on("dragover.dragout",c.update_elem)},teardown:function(e){d("body").off("dragover.dragout")},update_elem:function(e){if(e.target==c.current_elem){return}if(c.current_elem){d(c.current_elem).parents().andSelf().each(function(){if(d(this).find(e.target).size()==0){d(this).triggerHandler("dragout")}})}c.current_elem=e.target;e.stopPropagation()}}})(window.jQuery);