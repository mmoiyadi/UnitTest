stl.view.ResourcePicker=function(a){$.extend(this,a);if(!this.val){this.val=[]}if(typeof(this.defaultUnits)==="undefined"){this.defaultUnits=4}if(!this.blankItemTemplate){this.blankItemTemplate={resourceId:"",units:1}}this.$el=$(this.el);this.$el.data("resourcePicker",this);if(this.inputModeOnly){this.renderInputMode()}else{this.renderReadOnly()}};$.extend(stl.view.ResourcePicker.prototype,(function(){var a="__NEW_RESOURCE__",c=9,b=250;return({renderReadOnly:function(){var d=this,g=stl.view.ResourcePicker.getReadOnlyText(this.val,this.project),f=$('<span class="resource-picker-readonly-text"></span>');f.text(g);this.$el.empty().addClass("resource-picker").append(f);var e=$('<a href="javascript:;" class="resource-picker-tab-stop">#</a>');if(this.val===null||this.val.length===0){this.$el.addClass("empty")}else{this.$el.removeClass("empty")}if(this.readOnly){this.$el.addClass("readonly")}else{this.$el.removeClass("readonly")}e.on("focus",this.onTabStopFocus.bind(this));this.$el.append(e);this.$el.on("click",this.onElementClick.bind(this));this.isInEditMode=false;this.$el.trigger("resize")},onTabStopFocus:function(d){this.renderInputMode();d.stopPropagation()},onElementClick:function(d){if(!this.isInEditMode&&!this.readOnly){this.renderInputMode()}d.stopPropagation()},renderInputMode:function(){var f=this,e={},g=this.getAvailableResourceOptions(),d=['<div class="resource-picker-table">'].concat(g.map(this.getInputTableRowHtml)),i=this.$el.offset();d.push("</div>");this.$el.empty();if(!this.$popup){this.$popup=$(['<div class="resource-picker-popup">','<div class="resource-picker-scroll"></div>','<div class="resource-picker-buttons">','<button class="save-button btn">',OK_BUTTON,"</button>",'<button class="cancel-button btn">',CANCEL_BUTTON,"</button>","</div>","</div>"].join(""))}this.$popup.find(".resource-picker-scroll").html(d.join("")).on("scroll",this.onPopupScroll.bind(this));this.$popup.find(".resource-picker-table").on("scroll",this.onPopupScroll.bind(this));this.addPlaceholderItem();var h=this.$popup.find(".resource-picker-item");this.initItemInputs(h);if(this.val&&this.val!=NONE_RESOURCE){this.val.forEach(function(k){var j=this.$popup.find(".resource-picker-item[data-resource-id="+k.resourceId+"]");j.find(".resource-assigned input").attr("checked",true);j.find(".units input").val(k.units)}.bind(this))}this.$popup.find(".save-button").on("click",this.onSaveButtonClick.bind(this));this.$popup.find(".cancel-button").on("click",this.onCancelButtonClick.bind(this));this.$popup.find("button").on({focus:function(j){f.cancelClose()},blur:function(j){f.triggerClose()}});this.$popup.on("click",this.onPopupClick.bind(this));setTimeout(function(){$(document.body).append(this.$popup);this.$popup.show().offset({top:i.top,left:i.left});this.$popup.find(".resource-picker-item .resource-assigned input").first().focus()}.bind(this),0);this.isInEditMode=true;this.$el.trigger("resize")},onPopupClick:function(d){d.stopPropagation()},onPopupScroll:function(){this.cancelClose();if(!this.scrollCompleteDelegate){this.scrollCompleteDelegate=this.onPopupScrollComplete.bind(this)}if(this.scrollCompleteTimeout){window.clearTimeout(this.scrollCompleteTimeout)}this.scrollCompleteTimeout=window.setTimeout(this.scrollCompleteDelegate,b)},onPopupScrollComplete:function(){this.$popup.find(".save-button").focus()},saveAndExitInputMode:function(){this.$popup.hide();this.val=this.getValue(true);this.$el.trigger("change",this.val);this.renderReadOnly();this.$el.trigger("editcomplete")},onSaveButtonClick:function(){this.cancelClose();this.saveAndExitInputMode()},onCancelButtonClick:function(){this.cancelClose();this.$popup.hide();this.renderReadOnly()},getInputTableRowHtml:function(d){return['<div class="resource-picker-item" data-resource-id="',d.id,'">','<div class="resource-assigned"><input type="checkbox" /></div>','<div class="resource"><input type="text" class="resource-input" disabled="disabled" value="',d.text,'"/></div>','<div class="units"><input type="text" value="" /></div>',"</div>"].join("")},initItemInputs:function(h){var f=this,e=h.find(".resource-assigned input"),g=h.find(".resource input.resource-input"),d=h.find(".units input");d.on("focus",function(i){f.cancelClose();var j=$(this);window.setTimeout(function(){j.select()},10)}).on("blur",function(j){var m=/^[0-9]+([,.][0-9]+)?$/;var i=$(j.target),l=(i.val()==="");var k=i.val();if(!m.test(k)||i.val()=="0"){i.val("1")}f.triggerClose()}).on("keyup",function(j){var l=/^\d+$/;var i=$(j.target),m=(i.val()==="");var k=i.val()}).on("keypress",function(i){if(i.which==13){i.preventDefault()}}).on("change",function(j){var i=$(j.target),k=(i.val()==="");i.closest(".resource-picker-item").find(".resource-assigned input").prop("checked",!k)});e.on("change",function(i){if($(i.target).is(":checked")){var j=$(i.target).closest(".resource-picker-item").find(".units input");if(j.val()===""&&!j.is(":focus")){j.val("1")}}}).on("focus",function(i){f.cancelClose()}).on("blur",function(i){f.triggerClose()}).on("mousedown",function(i){i.stopPropagation()});h.on("mousedown",function(j){var i=$(j.target).closest(".resource-picker-item"),k=i.hasClass("new-item-placeholder");if(!k||!i.find(".resource-assigned input").is(":checked")){i.find(".resource-assigned input").trigger("click")}setTimeout(function(){if(!k){i.find(".units input").focus()}},10)});g.on({focus:function(i){f.cancelClose()},keypress:this.onResourceInputChange.bind(this),keydown:this.onResourceInputChange.bind(this)})},onResourceInputKeyDown:function(d){if(d.which===c){var e=$(d.target).closest(".resource-picker-item");if(e.hasClass("new-item-placeholder")&&e.find("input.resource-input").select2("val")==""){this.saveAndExitInputMode()}}},triggerClose:function(){if(!this.saveAndExitInputModeDelegate){this.saveAndExitInputModeDelegate=this.saveAndExitInputMode.bind(this)}if(this.pendingCloseTimeout){window.clearTimeout(this.pendingCloseTimeout)}this.pendingCloseTimeout=window.setTimeout(this.saveAndExitInputModeDelegate,250)},cancelClose:function(){if(this.pendingCloseTimeout){window.clearTimeout(this.pendingCloseTimeout)}},onResourceInputChange:function(d){if(d.type==KEYPRESS){if(d.which==13){d.preventDefault()}else{return}}var e=$(d.target).closest(".resource-picker-item");if(e.hasClass("new-item-placeholder")){e.removeClass("new-item-placeholder");this.addPlaceholderItem()}d.stopPropagation()},addPlaceholderItem:function(){this.$popup.find(".resource-picker-table").append(this.getInputTableRowHtml(this.blankItemTemplate));var d=this.$popup.find(".resource-picker-item").last();d.hide();this.initItemInputs(d);d.addClass("new-item-placeholder");d.find(".resource-input").attr("placeholder",ADD_RESOURCE_PLACEHOLDER).removeAttr("disabled");d.fadeIn()},onDeleteClick:function(d){var e=$(d.target).closest(".resource-picker-item"),f=this.$popup.find(".resource-picker-item").index(e);this.val.splice(f,1);e.remove()},getValue:function(d){if(this.isInEditMode){this.val=$.map(this.$popup.find(".resource-picker-item:not(.new-item-placeholder)"),function(i){var g=$(i),h=g.find(".resource-assigned input").is(":checked"),l=g.data("resource-id"),f=g.find(".units input").val();if(h){if(!stl.view.ResourcePicker.isResourcePickerPopupVisible(this.$popup)){if((l===null&&g.find(".resource-input").val().trim()!="")||(l===""&&g.find(".resource-input").val().trim()!="")){var j=stl.model.Project.getProject().isResourceNameDuplicate(g.find(".resource-input").val().toString(),null);var k=stl.model.Project.getProject().isVirtualResourceNameDuplicate(g.find(".resource-input").val().toString());if(!j&&!k){var e=this.project.createResource.call(this.project,g.find(".resource-input").val(),null,Number(f));g.data("resource-id",e.uid);l=e.uid}else{if(d){if(j){PPI_Notifier.error(RESOURCE_NAME_DUPLICATE,ERR_TYPE_RES_ASSIGNMENT)}else{if(k){PPI_Notifier.error(VIRTUAL_RESOURCE_NAME_DUPLICATE,ERR_TYPE_RES_ASSIGNMENT)}}}}}}if(l!=null&&l!=""){if(!j&&!k&&g.find(".resource-input").val().trim()!=""){return{resourceId:l,units:Number(f)}}}}}.bind(this))}return this.val},setValue:function(d){this.val=d;if(this.isInEditMode||this.inputModeOnly){this.renderInputMode()}else{this.renderReadOnly()}},getAvailableResourceOptions:function(){var d=[];this.project.getAvailableResources().forEach(function(e){if(e.Name.toLowerCase()!==TIME_BUFFER_LOWERCASE){d.push({id:e.uid,text:e.Name})}});return d},setReadOnly:function(d){this.readOnly=d;this.renderReadOnly()}})})());stl.view.ResourcePicker.getReadOnlyText=function(c,b){var a=b.getAvailableResourcesByUid();if(c===null||c.length===0){return NONE_RESOURCE}return c.map(function(f){var e=a[f.resourceId],d=e?e.Name:MISSING_RESOURCE;return d+"("+(f.units||0)+")"}).join(", ")};stl.view.ResourcePicker.isResourcePickerPopupVisible=function(b){var a=false;var c=b;a=($(c).css("display")=="block");return a};