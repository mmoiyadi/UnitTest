stl.view.TaskView=function(a){var b={};$.extend(this,b,a);if(a.insertAfter||a.insertBefore){this.render($(a.insertBefore),$(a.insertAfter))}if(a.task){this.load(a.task)}};$.extend(stl.view.TaskView.prototype,(function(){var a=(getInternetExplorerVersion()===-1)?275:290;return({load:function(d,c,e){var h=this,b=h.$el;this.task=d;b.data("model",d);b.data("view",this);b.attr("id",d.uid);if(typeof(d.name)!=="undefined"&&d.name!==null){b.find(".task-name input").val(d.name)}else{b.find(".task-name input").val("")}if(d.taskType===FULL_KIT){b.addClass("fullkit")}if(!c){}b.data("linkable-element-name",d.name);b.find("#task-id-value").text(d.id);this.updateChecklistStatus(d);b.find(".task-checklist-icon").addClass(this.project.getChecklistStatus(d.checklistStatus));this.setQuickEditStatusBox(b);b.find(".task-duration").val(ValidationClassInstance.getValidDurationString(d.remainingDuration,TASK_DURATION_DEFAULT_STR,false));if(d.taskType===TASKTYPE_FULLKIT&&d.date1){b.find(".needDate input").val(ServerTimeFormat.getDateInLocaleFormat(d.date1));b.find(".needDate input").prop("disabled",true)}b.find(".pullInFullKitDateBy input").val(ValidationClassInstance.getValidDurationString(d.fullkitPullInDuration,ZERO_DURATION_STR,false));if(d.isReadyToStart){b.addClass("readyToStart")}else{b.addClass("notReadyToStart")}if(e){this.invalidateResourceCache();this.onTaskResourceChangeFromTableView(b,d)}this.taskResourcePicker.setValue(d.resources||[]);this.taskResourcePicker.setReadOnly(this.readOnly||d.bufferType!=="None");if(!e){for(var f=0;f<d.resources.length;f++){var g=this.getResourceById(d.resources[f].resourceId);if(g){Ext.getCmp("resGrid").updateResourceSheet(g,d.resources[f].units,g.taskdata)}}}if(d.taskType===FULL_KIT&&this.phase.type!==STRING_NORMAL){if(!d.isAutolinked){d.isAutolinked=false}if(d.isAutolinked){b.find(".fk-autolink input").prop("checked",true)}else{b.find(".fk-autolink input").prop("checked",false)}}if(this.isSubtaskEnabled){b.find(".subtasks li.subtask:not(.proto-subtask)").remove();if(d.subtasksWIPLimit<=0){d.subtasksWIPLimit=stl.app.commonSettingValue("SUBTASKS_DEFAULT_WIP_LIMIT")}b.find(".subtask-type .WIP_Limit_textbox").val(d.subtasksWIPLimit);d.remainingSubtasks=0;var n=$("#templates li[data-role=subtask-template]"),l=b.find("li.proto-subtask");for(var f=0;f<d.subtasks.length;f++){var m=d.subtasks[f],k=(this.includeCompletedSubtask)?true:!m.complete;if(k){var j=n.clone(true).removeClass("proto-subtask").removeAttr("data-role");j.find(".subtask-name input").removeClass("placeholdersjs");this.bindSubtask(j,m);l.before(j)}if(m.status!="CO"){d.remainingSubtasks++}}d.subtaskCount=d.subtasks.length;this.refreshRemainingSubtasksIndicator();b.find(".subtasks ul").sortable("update");this.bindSubtaskTypeSpecificProperties()}else{this.refreshRemainingSubtasksIndicator();b.find(".subtasks").hide();b.find(".subtask-type select").hide()}this.addClassForTaskStatus(b);this.bindTaskTypeSpecificProperties(d.taskType);this.updateWIPLimitNotification(d,b);b.data("last-height",b.height());this.updateCCTaskColor(b,d);this.updateTaskResourceColors(b,d);this.updateTaskPhaseColors(b,d);this.updateTaskManagerColors(b,d);this.processZeroDurationTask();if(d.bufferType==="CCCB"||d.bufferType==="CCFB"||d.bufferType==="CMSB"){b.addClass("buffer-task "+d.bufferType.toLowerCase()+"-task")}this.wireSubTaskEvents();if(this.readOnly){b.addClass("readonly");b.find(":input").prop("disabled",true)}else{b.removeClass("readonly")}this.checkTaskForDefaultName(b);b.find(".task-color").css("background-color",d.taskColor);b.find(".fullkit-color").css("background-color",d.taskColor);this.setTooltip(d);this.setToolTipOfWIPLimitImage(b)},setTooltip:function(b){this.$el[0].title=b.name},setToolTipOfWIPLimitImage:function(b){b.find(".imgWIP").attr("title",NUMBER_OF_IP_TASKS_EXCEED_WIP_LIMIT)},updateChecklistStatus:function(b){b.checklistStatus=0;var d=b.checklistItems;if(d.length>0){var c=0;var f=0;var e=true;d=d.map(function(h,g){c=1;if(!h.complete){e=false}else{f++}h.order=g;return h});if((c==1&e==true)){c=2}b.checklistStatus=c}},addClassForTaskStatus:function(b){switch(this.task.status){case"NS":b.removeClass("RL");b.removeClass("IP");b.removeClass("CO");b.addClass("NS");break;case"IP":b.removeClass("RL");b.removeClass("NS");b.removeClass("CO");b.addClass("IP");break;case"RL":b.removeClass("IP");b.removeClass("NS");b.removeClass("CO");b.addClass("RL");break;case"CO":b.removeClass("RL");b.removeClass("IP");b.removeClass("NS");b.addClass("CO");break}},disableOrEnableTaskField:function(d,c,b){d.find(c).prop("disabled",b)},enableOrDisableExpectedFinishDate:function(c){if(this.readOnly){return}var b=".expectedFinishDate input";switch(this.task.status){case STATUS_NS:case STATUS_CO:this.disableOrEnableTaskField(c,b,true);break;case STATUS_IP:case STATUS_RL:this.disableOrEnableTaskField(c,b,false);break}},enableOrDisablePullInDuration:function(c){if(this.readOnly){return}var b=".pullInFullKitDateBy input";switch(this.task.status){case STATUS_NS:this.disableOrEnableTaskField(c,b,false);break;case STATUS_IP:case STATUS_RL:case STATUS_CO:this.disableOrEnableTaskField(c,b,true);break}},showSubtasksRegion:function(b){var c=b.find(".subtasks");if(!c.is(":visible")&&this.insertBefore!==INSERT_TASK_BEFORE_TIMELINE_VIEW){c.show()}},hideSubtasksRegion:function(b){var c=b.find(".subtasks");if(c.is(":visible")){c.hide()}},onTaskZoomClick:function(b){if(this.task.bufferType!=="None"){return}this.initializeTaskQuickEditMode(this.$el);this.initializeTaskZoomMode(this.$el);if(this.$el.hasClass("quick-task-edit")){this.$el.removeClass("quick-task-edit")}$(this).trigger("zoom",[b]);b.stopPropagation()},pasteSubtasksCallbk:function(c){for(var b=0;b<c.length;b++){if(c[b].trim()!=""){var d=this.$el.find(".proto-subtask");this.renderNewSubtask(d,c[b],false)}}},initializeTaskZoomMode:function(g){var d=this.task;var c=g.find(".task-manager input");var e=g.find(".task-participants input");var f=g.find(".task-type select");var b=g.find(".subtask-type select");if(!this.initializedTaskZoomMode){c.select2({placeholder:NONE_PLACEHOLDER,allowClear:true,dropdownAutoWidth:true,query:this.managerDropDownQuery.bind(this),initSelection:this.managerDropDownInitSelection.bind(this)}).on("change",this.onGenericTaskPropertyInputChange.bind(this,"manager"));e.select2({multiple:true,placeholder:NONE_PLACEHOLDER,width:200,dropdownAutoWidth:true,query:this.participantsDropDownQuery.bind(this),initSelection:this.participantsDropDownInitSelection.bind(this)}).on("change",this.onGenericTaskPropertyInputChange.bind(this,"participants"));f.select2({dropdownAutoWidth:true,minimumResultsForSearch:-1}).on("change",this.onTaskTypeChange.bind(this));b.select2({dropdownAutoWidth:true,minimumResultsForSearch:-1}).on("change",this.onTaskSubtaskTypeChange.bind(this))}c.select2("val",d.manager);e.select2("val",d.participants||[]);f.select2("val",d.taskType);b.select2("val",d.subtaskType);this.initializedTaskZoomMode=true},onTaskAddButtonClick:function(b){if(this.$el.hasClass("quick-task-edit")){this.$el.removeClass("quick-task-edit");this.exitQuickEditMode()}$(this).trigger("addTask",[b])},onTaskIconMousedown:function(b){b.stopPropagation()},saveNameField:function(c){var b=this.task.name;this.task.name=c;if(b!==c&&multipleORs(this.task.taskType,TASKTYPE_FULLKIT,TASKTYPE_PT)&&this.project.isIDCCed){Ext.getCmp("CCSummarygrid").UpdateFullKitNameInCCSummary(this.task)}this.setTooltip(this.task)},saveStatusField:function(b){if(this.task.taskType!="fullkit"){this.task.status=b.find(".task-status select").select2("val")}this.setQuickEditStatusBox(b)},saveResourceField:function(b){this.task.resources=b.find(".task-resources .input-field").data("resourcePicker").getValue()},saveManagerField:function(b){this.task.manager=b.find(".task-manager input").select2("val")},saveParticipantField:function(b){this.task.participants=b.find(".task-participants input").select2("val")},saveSubtasks:function(c){var b=this;this.task.subtasks=[];this.task.remainingSubtasks=0;c.find(".subtasks > ul > li:not(.proto-subtask)").each(function(e,d){var g=$(d),f=g.data("model");b.saveSubtask(g);if(f.status!=="CO"){b.task.remainingSubtasks++}f.order=e;b.task.subtasks.push(f)});this.task.subtaskCount=this.task.subtasks.length;this.refreshRemainingSubtasksIndicator()},saveWIPLimitField:function(c){var b=this;b.task.subtasksWIPLimit=c.find(".subtask-type .WIP_Limit_textbox").val()},render:function(h,f){var e=this,b=$("#templates div[role=task-template]"),g=b.clone(true);this.$el=g;if(f&&f.length>0){f.after(g)}else{if(h&&h.length>0){h.before(g)}}if(!this.isSubtaskEnabled){g.find(".subtask").hide()}this.$el.find(".task-name input").on({change:function(i,m){var l=e.$el,n=l.find(".task-name input"),j=n.val().trim(),k=l.data("model");if(j){l.data("linkable-element-name",j);e.saveNameField(j)}else{n.val(k.name);PPI_Notifier.info(EMPTY_TASK_NAME_NOT_ALLOWED)}}});this.$el.find(".task-name-overflow-edit").on("keyup",function(i){if(i.which===13){e.exitQuickEditMode();setTimeout(function(){this.blur()}.bind(this),0)}});this.$el.find(".task-name-overflow-edit").on("blur",function(i,k){var j=i.currentTarget.textContent;if(j&&e.$el.data("model").name!=j){e.$el.find(".task-name input").val(i.currentTarget.textContent);e.saveNameField(j)}});g.on("click",this.onClick.bind(this));g.on("rollupDurationChange",this.onRollupDurationChange.bind(this));g.find(".task-duration").on("change",this.onTaskDurationChange.bind(this)).on("click",this.onTaskDurationClick.bind(this)).on("keypress",this.onTaskDurationChange.bind(this));g.find(".WIP_Limit_textbox").on("blur",this.onWIPLimitChange.bind(this)).on("keypress",this.onkeyPressInWIPLimit.bind(this));g.find(".pullInFullKitDateBy input").on("change",this.onPullInDurationChange.bind(this)).on("click",this.onPullInDurationClick.bind(this)).on("keypress",this.onPullInDurationChange.bind(this));if(this.phase.type===STRING_NORMAL){DOMManipulatorWrapperInstance.findElementsByClsNames(g,"fk-autolink").hide()}else{g.find(".fk-autolink input").on({change:this.onAutoLinkAllChange.bind(this)})}var d=g.find(".task-resources .input-field"),c=new stl.view.ResourcePicker({el:d,val:[],project:this.project,readOnly:(this.readOnly||(this.task&&this.task.bufferType!=="None"))});d.on({resize:this.onTaskResourcePickerResize.bind(this),change:this.onTaskResourceChange.bind(this)});this.taskResourcePicker=c;g.find(".task-magnify-button").on({click:this.onTaskZoomClick.bind(this),mousedown:this.onTaskIconMousedown.bind(this)});g.find(".delete-task-button").on({click:this.onDeleteTaskButtonClick.bind(this),mousedown:this.onTaskIconMousedown.bind(this)});g.find(".ok-task-button").on({click:this.onOkTaskButtonClick.bind(this)});g.find(".add-task-plus-icon").on({click:this.onTaskAddButtonClick.bind(this),mousedown:this.onTaskIconMousedown.bind(this)});g.find(".task-properties .task-checklist-icon").off().on("click",function(i){var j;if($(i.target).closest(".fk").length>0){j=$(i.target).closest(".fk")}else{j=$(i.target).closest(".task").length==0?$(i.target).closest(".ms"):$(i.target).closest(".task")}if(window.currentViewId=="timeline"){Ext.getCmp("timelineview").showChecklistPopupForTask($(j))}else{$(".matrix-view").data("view").showChecklistPopupForTask($(j))}i.stopPropagation()});g.find(".status-indicator").on("click",this.onStatusIndicatorClick.bind(this));if(this.isSubtaskEnabled){g.find(".subtasks ul").sortable({handle:".drag-handle",group:"subtasks",distance:3,itemSelector:"li:not(.proto-subtask)",placeholder:'<li class="subtask-placeholder"><div class="arrowhead">&#x25b6;</div></li>',onMousedown:function(i,k,j){return !e.readOnly},onDragStart:function(j,k,i){e.$el.addClass("dragging-subtask");i(j)},onDrop:function(k,i,j){e.$el.removeClass("dragging-subtask");var l=$("<li/>").css({height:0});k.before(l);l.animate({height:k.height()});k.animate(l.position(),function(){l.detach();j(k)})},});this.wireSubTaskEvents();g.find(".subtask-specific-properties input").on("change",this.onGenericTaskPropertyInputChange.bind(this,"subtask"))}$(this.project).on("resourceschanged",this.invalidateResourceCache.bind(this))},onAutoLinkAllChange:function(b){this.task.isAutolinked=b.currentTarget.checked;$(this).trigger("autolinkallChange",[$(this.$el),b.currentTarget.checked])},onStatusIndicatorClick:function(c){if(this.readOnly){return}var b=this.task.status||STATUS_NS;switch(b){case STATUS_NS:if(this.project.checkIfZeroDurationTask(this.task)){this.task.status=STATUS_CO}else{this.task.status=STATUS_IP}break;case STATUS_IP:if(this.task.taskType===TASKTYPE_FULLKIT){this.task.status=STATUS_RL}else{this.task.status=STATUS_CO}break;case STATUS_RL:this.task.status=STATUS_CO;break;case STATUS_CO:break}this.$el.find(".task-status select").select2("val",this.task.status);$(this.$el.find(".task-status select")).trigger("change",[b,false])},setTaskStateBasedOnTaskStatus:function(c){switch(c.status){case"NS":c.actualStartDate=null;c.actualFinishDate=null;c.fullkitPercentCompleteAtRL=0;if(c.taskType=="fullkit"){c.remainingDuration=0;c.duration=0;c.date7=c.date1;this.$el.find(".expectedFinishDate input").val(ServerTimeFormat.getDateInLocaleFormat(c.date7))}else{c.remainingDuration=c.remainingDuration==0?ONE_DAY_DURATION_DEFAULT_SEC:c.remainingDuration;c.duration=c.remainingDuration}c.percentComplete=0;c.fullkitReleaseDate=null;break;case"IP":c.actualStartDate=ServerClientDateClass.getTodaysDate();var b=new Date(this.project.defaultStartTime);c.actualStartDate.setHours(b.getHours());c.actualStartDate.setMinutes(b.getMinutes());c.actualStartDate.setSeconds(b.getSeconds());c.actualFinishDate=null;c.fullkitPercentCompleteAtRL=0;if(c.taskType=="fullkit"){c.remainingDuration=0;c.duration=0;if(new Date(c.date7)<new Date()){c.date7=ServerClientDateClass.getTodaysDate();this.$el.find(".expectedFinishDate input").val(ServerTimeFormat.getDateInLocaleFormat(c.date7))}}else{c.remainingDuration=c.remainingDuration==0?ONE_DAY_DURATION_DEFAULT_SEC:c.remainingDuration;c.percentComplete=0}c.fullkitReleaseDate=null;break;case"RL":c.fullkitReleaseDate=ServerClientDateClass.getTodaysDate();c.fullkitPercentCompleteAtRL=c.percentComplete;break;case"CO":c.actualStartDate=c.actualStartDate?c.actualStartDate:ServerClientDateClass.getTodaysDate();c.actualFinishDate=ServerClientDateClass.getTodaysDate();c.actualFinishDate.setHours(17,0,0);c.fullkitPercentCompleteAtRL=100;c.fullkitReleaseDate=c.fullkitReleaseDate?c.fullkitReleaseDate:ServerClientDateClass.getTodaysDate();c.remainingDuration=0;c.percentComplete=100;break}},onStatusDropdownChange:function(d,g,c){if(this.readOnly){return}var f=this;if(!g){g=this.task.status}this.task.status=this.$el.find(".task-status select").select2("val");var b=this.task.status||"NS";function e(i,h){switch(i){case"NS":h.$el.find(".task-duration").val(ValidationClassInstance.getValidDurationString(h.task.remainingDuration,TASK_DURATION_DEFAULT_STR,false));break;case"IP":h.$el.find(".task-duration").val(ValidationClassInstance.getValidDurationString(h.task.remainingDuration,TASK_DURATION_DEFAULT_STR,false));break;case"RL":break;case"CO":h.$el.find(".task-duration").val(ValidationClassInstance.getValidDurationString(h.task.remainingDuration,TASK_DURATION_DEFAULT_STR,false));break;f.saveDurationField(i,f.task,ValidationClassInstance.getValidDuration(h.task.remainingDuration,TASK_DURATION_DEFAULT_SEC,false))}}if(!c){this.taskStatusChangeValidations(g,b,function(h){if(h=="yes"){f.setTaskStateBasedOnTaskStatus(f.task);e(b,f);f.addClassForTaskStatus(f.$el);f.enableOrDisableExpectedFinishDate(f.$el);f.enableOrDisablePullInDuration(f.$el)}f.saveStatusField(f.$el)})}else{f.saveStatusField(f.$el)}},taskStatusChangeValidations:function(e,b,c){var d=this;if(e=="NS"&&b=="IP"){ChangeTaskStatusFromNSToIP();c("yes")}else{if(e=="NS"&&b=="CO"){ChangeTaskStatusFromNSToCO(this.task.name,this.task,this.task.subtasks,null,function(f){if(f=="no"){d.task.status="NS";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{if(d.task.taskType!="fullkit"){d.setSubtaskStatus()}d.refreshChecklistIconForTask(d.$el,d.task);c("yes")}})}else{if(e=="IP"&&b=="CO"){ChangeTaskStatusFromIPToCO(this.task.name,this.task,this.task.subtasks,null,function(f){if(f=="no"){d.task.status="IP";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{if(d.task.taskType!="fullkit"){d.setSubtaskStatus()}d.refreshChecklistIconForTask(d.$el,d.task);c("yes")}})}else{if(e=="IP"&&b=="NS"){ChangeTaskStatusFromIPToNS(this.task.name,this.task,this.task.subtasks,function(f){if(f=="no"){d.task.status="IP";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{if(d.task.taskType!="fullkit"){d.setSubtaskStatus()}d.refreshChecklistIconForTask(d.$el,d.task);c("yes")}})}else{if(e=="CO"&&b=="IP"){ChangeTaskStatusFromCOToIP(this.task.name,this.task,this.task.subtasks,null,function(){if(d.task.taskType!="fullkit"){d.setSubtaskStatus()}d.refreshChecklistIconForTask(d.$el,d.task);c("yes")})}else{if(e=="CO"&&b=="NS"){ChangeTaskStatusFromCOToNS(this.task.name,this.task,this.task.subtasks,null,function(f){if(f=="no"){d.task.status="CO";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{d.setSubtaskStatus();d.refreshChecklistIconForTask(d.$el,d.task);c("yes")}})}else{if(e=="NS"&&b=="RL"){ChangeTaskStatusFromNSToRL(this.task.name,this.task,function(f){if(f=="no"){d.task.status="NS";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{d.refreshChecklistIconForTask(d.$el,d.task)}c("yes")})}else{if(e=="IP"&&b=="RL"){ChangeTaskStatusFromIPToRL(this.task.name,this.task,function(f){if(f=="no"){d.task.status="IP";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{d.refreshChecklistIconForTask(d.$el,d.task)}c("yes")})}else{if(e=="CO"&&b=="RL"){ChangeTaskStatusFromCOToRL(this.task.name,this.task,function(f){if(f=="no"){d.task.status="CO";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{d.refreshChecklistIconForTask(d.$el,d.task)}c("yes")})}else{if(e=="RL"&&b=="NS"){ChangeTaskStatusFromRLToNS(this.task.name,this.task,function(f){if(f=="no"){d.task.status="RL";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{d.refreshChecklistIconForTask(d.$el,d.task)}c("yes")})}else{if(e=="RL"&&b=="IP"){c("yes")}else{if(e=="RL"&&b=="CO"){ChangeTaskStatusFromRLToCO(this.task.name,this.task,function(f){if(f=="no"){d.task.status="RL";d.$el.find(".task-status select").select2("val",d.task.status);d.refreshChecklistIconForTask(d.$el,d.task);c("no")}else{d.refreshChecklistIconForTask(d.$el,d.task)}c("yes")})}else{c("yes")}}}}}}}}}}}}},refreshChecklistIconForTask:function(c,b){c.find(".task-checklist-icon").removeClass("none incomplete complete").addClass(this.project.getChecklistStatus(b.checklistStatus));c.data("model").checklistStatus=b.checklistStatus},setSubtaskStatus:function(){var h=this;if(h.isSubtaskEnabled){h.$el.find(".subtasks li.subtask:not(.proto-subtask)").remove();h.task.remainingSubtasks=0;var d=$("#templates li[data-role=subtask-template]"),e=h.$el.find("li.proto-subtask");for(var f=0;f<h.task.subtasks.length;f++){var g=h.task.subtasks[f],c=(h.includeCompletedSubtask)?true:!g.complete;if(c){var b=d.clone(true).removeClass("proto-subtask").removeAttr("data-role");h.bindSubtask(b,g);e.before(b);this.setDurationAndDatesForSubtask(g,b)}if(!g.complete){h.task.remainingSubtasks++}}h.task.subtaskCount=h.task.subtasks.length;h.refreshRemainingSubtasksIndicator()}},subtaskStatusChangeValidations:function(e,f,h,b,g,c){var d=this;if(e==="NS"&&f==="IP"){ChangeSubtaskStatusFromNSToIP(h,b,function(i){if(i=="no"){}else{d.setTaskStatus("IP",d.$el)}c()})}else{if(e==="NS"&&f==="CO"){ChangeSubtaskStatusFromNSToCO(h,b,null,function(j,i){if(j=="no"||i=="no"){d.setTaskStatus("IP",d.$el)}else{d.setTaskStatus("CO",d.$el)}c()})}else{if(e==="IP"&&f==="CO"){ChangeSubtaskStatusFromIPToCO(h,b,null,function(j,i){if(j=="no"||i=="no"){d.setTaskStatus("IP",d.$el)}else{d.setTaskStatus("CO",d.$el)}c()})}else{if(e==="IP"&&f==="NS"){ChangeSubtaskStatusFromIPToNS(h,b,null,function(j,i){if(j=="no"||i=="no"){d.setTaskStatus("IP",d.$el)}else{d.setTaskStatus("NS",d.$el)}c()})}else{if(e==="CO"&&f==="NS"){ChangeSubtaskStatusFromCOToNS(h,b,null,function(j,i){if(j=="no"||i=="no"){d.setTaskStatus("IP",d.$el)}else{d.setTaskStatus("NS",d.$el)}c()})}else{if(e==="CO"&&f==="IP"){ChangeSubtaskStatusFromCOToIP(h,b,function(i){if(i=="no"){d.setTaskStatus("IP",d.$el)}else{d.setTaskStatus("IP",d.$el)}c()})}else{}}}}}}},setTaskStatus:function(b,c){c.find(".task-status select").select2("val",b);c.find(".task-status select").trigger("change",[b,false])},bindSubtask:function(e,d){e.data("model",d);e.find(".subtask-name input").val(d.name);e.find(".subtask-duration input").val(ValidationClassInstance.getValidDurationString(d.remainingDuration,SUBTASK_DURATION_DEFAULT_STR,false));e.find(".subtask-duration input").on("change",this.onSubtaskDurationChange.bind(this));e.find(".subtask-duration input").on("keypress",this.onSubtaskDurationChange.bind(this));e.find(".subtask-checklist-icon").addClass(this.project.getChecklistStatus(d.checklistStatus));var b=new stl.view.ResourcePicker({el:e.find(".subtask-resources"),val:d.resources,project:this.project,readOnly:this.readOnly});e.find(".subtask-resources").on("change",this.onSubtaskResourcesChange.bind(this));e.find(".delete-subtask").on("click",this.onDeleteSubTaskButtonClick.bind(this));this.refreshSubtaskStatus(e);this.refreshChecklistIcon(e,d);e.find(".subtask-status").on("click",this.onSubtaskStatusClick.bind(this));var c=e.find(".subtask-owner");c.select2({placeholder:NONE_PLACEHOLDER,allowClear:true,query:this.managerDropDownQuery.bind(this),initSelection:this.managerDropDownInitSelection.bind(this)}).on("change",this.onGenericSubtaskPropertyChange.bind(this));c.select2("val",d.manager||"");c.select2("enable",!this.readOnly)},refreshSubtaskStatus:function(b){b.removeClass("subtask-status-NS subtask-status-IP subtask-status-CO").addClass("subtask-status-"+this.getSubtaskStatus(b.data("model").status))},refreshChecklistIcon:function(c,b){c.find(".subtask-checklist-icon").removeClass("none incomplete complete").addClass(this.project.getChecklistStatus(b.checklistStatus));c.data("model").checklistStatus=b.checklistStatus},getSubtaskStatus:function(b){try{switch(b){case"NS":case"0":return"NS";break;case"IP":case"1":return"IP";break;case"CO":case"2":return"CO";break}}catch(c){throw"Subtask status code not recognized: "+b}},saveSubtask:function(d){var b=d.data("model"),c=d.find(".subtask-duration input").val();$.extend(b,{name:d.find(".subtask-name input").val(),manager:d.find(".subtask-owner").select2("val"),remainingDuration:c==""?0:ValidationClassInstance.getValidDuration(d.find(".subtask-duration input").val(),SUBTASK_DURATION_DEFAULT,false),startDate:d.data("model").startDate,endDate:d.data("model").endDate,status:d.data("model").status,resources:d.find(".subtask-resources").data("resourcePicker").getValue()})},onTaskTypeChange:function(b){var e=$(b.target).closest(".task"),c=e.data("model");var d=c.taskType;c.taskType=b.val;this.bindTaskTypeSpecificProperties(d)},onTaskSubtaskTypeChange:function(b){var d=$(b.target).closest(".task"),c=d.data("model");c.subtaskType=b.val;this.bindSubtaskTypeSpecificProperties();this.project.reCalculateSubTaskStartDate(c);d.trigger("rollupDurationChange")},onRollupDurationChange:function(b){var d=this,f=this.$el,c=this.task;var e=this.project.calculateRollupDuration(c);if(e>c.remainingDuration&&c.taskType!="purchasing"){PPI_Notifier.confirm(ROLLUP_DURATION_ALERT_MESG,ROLLUP_DURATION_ALERT_TITLE,function(){d.changeTaskDuration(f,e,c)},null)}},changeTaskDuration:function(d,b,c){if(c.status===STATUS_NS){c.duration=b}c.remainingDuration=b;d.find(".task-duration").val(ValidationClassInstance.getValidDurationString(b,TASK_DURATION_DEFAULT_STR,false))},onTaskDurationChange:function(d){if(d.type==KEYPRESS){if(d.which==13){d.preventDefault()}else{return}}var f=$(d.target),h=f.closest(".task"),e=h.data("model"),g=f.val();if(e.status=="CO"){g=0}var c=ValidationClassInstance.getValidDuration(g,TASK_DURATION_DEFAULT,true);f.val(ValidationClassInstance.getValidDurationString(c,TASK_DURATION_DEFAULT_STR,true));var b=this.task.status||"NS";if((e.remainingDuration==0&&c!=0)||(c==0&&e.remainingDuration!=0)){this.refreshLinkForZeroDurationTask=true}this.saveDurationField(b,e,c);if(this.project.checkIfZeroDurationTask(e)){this.removeIPOptionFromTaskStatus(h)}else{this.appendIPOptionForTaskStatus(h)}this.removeAppendIPOptionAlreadyDone=true},onkeyPressInWIPLimit:function(c){c=(c)?c:window.event;var b=(c.which)?c.which:c.keyCode;if(b>31&&(b<48||b>57)){return false}return true},onWIPLimitChange:function(b){var g=$(b.target).closest(".task"),c=g.data("model");var f=g.find(".subtask-type .WIP_Limit_textbox");var e=c.subtasksWIPLimit;var d=f.val();if(d&&isValidNumber(d)&&d!=0){this.saveWIPLimitField(g);this.updateWIPLimitNotification(c,g);if(stl.app.isValueChanged(e,d)){g.trigger("rollupDurationChange")}}else{f.val(e);PPI_Notifier.error(INVALID_WIP_LIMIT)}},onPullInDurationChange:function(d){var c;var j=$(d.target).closest(".fk").length==0?$(d.target).closest(".task"):$(d.target).closest(".fk"),f=j.data("model");try{if(d.type==KEYPRESS){if(d.which==13){d.preventDefault()}else{return}}var g=$(d.target),i=g.val();c=ValidationClassInstance.getValidDuration(i,0,true);g.val(ValidationClassInstance.getValidDurationString(c,ZERO_DURATION_STR,true))}catch(h){c=f.fullkitPullInDuration}if(c!==undefined){this.UpdateFKDates(f,j,c);var b=this.task.status||STATUS_NS;this.setPullInDurationField(b,f,c);if(this.project.isIDCCed){Ext.getCmp("CCSummarygrid").UpdateFullKitDataInCCSummary(f)}}},UpdateFKDates:function(d,e,c){var g=d.fullkitPullInDuration;g=(Math.floor(g/ONE_DAY_DURATION_DEFAULT_SEC))*ONE_DAY_DURATION_DEFAULT_SEC;var f=(Math.floor(c/ONE_DAY_DURATION_DEFAULT_SEC))*ONE_DAY_DURATION_DEFAULT_SEC;if(f!=g){if(g<f){var b=f-g;d.date1=d.date7=this.project._scheduler.adjustDatesForDuration(new Date(d.date7),b,false)}else{if(g>f){var b=g-f;d.date1=d.date7=this.project._scheduler.adjustDatesForDuration(new Date(d.date7),b,true)}}if(d.date7){e.find(".expectedFinishDate input").val(ServerTimeFormat.getDateInLocaleFormat(d.date7))}if(d.date1){e.find(".needDate input").val(ServerTimeFormat.getDateInLocaleFormat(d.date1))}}},onTaskDurationClick:function(b){if($(b.target).closest(".task").hasClass("quick-task-edit")){b.stopPropagation()}},onPullInDurationClick:function(b){if($(b.target).closest(".task").hasClass("quick-task-edit")){b.stopPropagation()}},onSubtaskDurationChange:function(e){if(e.type==KEYPRESS){if(e.which==13){e.preventDefault()}else{return}}var f=$(e.target),h=f.closest(".subtask").data("model"),g=f.closest(".subtask").closest(".task");val=f.val();if(h.status==="CO"){val=0}else{if(ZERO_DURATION_REGEX.test(f.val())){PPI_Notifier.info(getStringWithArgs(ZERO_DURATION_NOT_ALLOWED,SUBTASKS));val=SUBTASK_DURATION_DEFAULT}}var b=h.remainingDuration;var d=ValidationClassInstance.getValidDuration(val,SUBTASK_DURATION_DEFAULT,true);f.val(ValidationClassInstance.getValidDurationString(d,SUBTASK_DURATION_DEFAULT_STR,true));var c=h.status||"NS";this.saveDurationField(c,h,d);this.project.reCalculateSubTaskStartDate(g.data("model"));if(stl.app.isValueChanged(b,d)){g.trigger("rollupDurationChange")}},saveDurationField:function(c,d,b){switch(c){case"NS":d.duration=b;d.remainingDuration=b;break;case"IP":d.remainingDuration=b;break;case"CO":d.remainingDuration=0;break}},setPullInDurationField:function(c,d,b){if(c===STATUS_NS){d.fullkitPullInDuration=b}},onSubtaskResourcesChange:function(b){var d=this,c=$(b.target).closest(".subtask"),f=c.data("model"),e=c.closest(".task");this.saveSubtasks(e);var g=f.resources.map(function(h){return d.getResourceById(h.resourceId)});this.project.onResourcesAssigned(g)},onGenericSubtaskPropertyChange:function(b){this.saveSubtasks(this.$el)},refreshRemainingSubtasksIndicator:function(){var c=this.$el.find(".remaining-subtasks-indicator"),b=this.$el.find(".subtask-type");if(this.isSubtaskEnabled){c.text(this.task.remainingSubtasks).toggle(!!this.task.remainingSubtasks);if(this.task.subtasks.length>0){if(!this.$el.hasClass("quick-task-edit")){b.show()}}else{b.hide()}}else{c.hide();b.hide()}},refreshStatusIndicator:function(){if(this.task.bufferType!=="None"){return}this.$el.find(".status-indicator").hide();this.$el.find(".status-indicator-"+(this.task.status||"NS")).show()},setQuickEditStatusBox:function(d){var c=d.find(".task-status select");var b=this.task;if(!this.initializedQuickEdit){c.select2({dropdownAutoWidth:true,minimumResultsForSearch:-1}).on("change",this.onStatusDropdownChange.bind(this))}c.select2("val",b.status);this.initializedQuickEdit=true},processZeroDurationTask:function(){var c=this.$el,b=this.task;if(this.project.checkIfZeroDurationTask(b)){var d=c.hasClass("quick-task-edit");if(d){c.removeClass("zero-duration-task")}else{c.addClass("zero-duration-task")}if(!this.removeAppendIPOptionAlreadyDone){this.removeIPOptionFromTaskStatus(c)}}else{this.$el.removeClass("zero-duration-task");if(!this.removeAppendIPOptionAlreadyDone){this.appendIPOptionForTaskStatus(c)}}this.removeAppendIPOptionAlreadyDone=true},saveSubtaskTypeSpecificProperties:function(d,c){var b=d.find(".subtask-specific-properties");c.volume=b.find(".volume").val();c.wipLimit=b.find(".wip-limit").val();c.units=b.find(".units").val()},onSNETChange:function(b){var h=$(b.target).closest(".task"),c=h.data("model");var d=null;try{var f=h.find(".snet input").datepicker("getDate");if(!isNaN(f)){d=f}else{if(c.startNoEarlierThan){d=new Date(c.startNoEarlierThan)}else{d=ServerClientDateClass.getTodaysDate()}}}catch(g){}if(!isNaN(d)){c.startNoEarlierThan=f}if(!isNaN(f)){h.find(".snet input").val(ServerTimeFormat.getDateInLocaleFormat(d))}},onExpectedFinishDateChange:function(b){var h=$(b.target).closest(".fk").length==0?$(b.target).closest(".task"):$(b.target).closest(".fk"),c=h.data("model");var d=null;try{var f=h.find(".expectedFinishDate input").datepicker("getDate");if(!isNaN(f)){d=f}else{if(c.date7){d=new Date(c.date7)}else{d=ServerClientDateClass.getTodaysDate()}}}catch(g){}if(!isNaN(d)){c.date7=d}if(!isNaN(f)){h.find(".expectedFinishDate input").val(ServerTimeFormat.getDateInLocaleFormat(d))}},onGenericTaskPropertyInputChange:function(c,b){switch(c){case"manager":this.updateTaskManagerColors();this.saveManagerField(this.$el);break;case"participants":this.saveParticipantField(this.$el);break;case"subtask":this.saveSubtasks(this.$el);break}},onTaskResourceChange:function(k,f){var h=this,b=$(k.target).closest(".task"),d=b.data("model");this.saveResourceField(b);if(d.resources.length>0){for(var g=0;g<d.resources.length;g++){var j=d.resources[g],c=this.getResourceById(j.resourceId);Ext.getCmp("resGrid").updateResourceSheet(c,j.units,d)}}else{}this.updateTaskResourceColors(b,d);var e=d.resources.map(function(i){return h.getResourceById(i.resourceId)});this.project.onResourcesAssigned(e);$(this).trigger("resourcechange")},onTaskResourceChangeFromTableView:function(d,b){var c=this;this.updateTaskResourceColors(d,b);var e=b.resources.map(function(f){return c.getResourceById(f.resourceId)});this.project.onResourcesAssigned(e);$(this).trigger("resourcechange")},onTaskResourcePickerResize:function(b){var c=$(b.target).closest(".task");this.checkForTaskHeightChange(c)},checkForTaskHeightChange:function(d){var c=d.data("last-height"),b=d.height();if(b!==c){d.data("last-height",b);$(this).trigger("resize")}},managerDropDownQuery:function(b){b.callback({results:this.getAvailableManagerOptions()})},managerDropDownInitSelection:function(b,c){if(!this.cachedManagersById){this.getAvailableManagerOptions()}this.dropDownInitSelection(b,c,this.cachedManagersById,"FullName")},dropDownInitSelection:function(c,i,g,d){var h=c.select2("val"),f=null;if(h){var e=g[h],b=(e?e[d]:h);f={id:h,text:b}}i(f)},participantsDropDownQuery:function(b){b.callback({results:this.getAvailableManagerOptions()})},participantsDropDownInitSelection:function(b,e){var c=this;if(!this.cachedManagersById){this.getAvailableManagerOptions()}var d=b.select2("val").map(function(h){var g=c.cachedManagersById[h],f=(g?g.FullName:h);return{id:h,text:f}});e(d)},getManagerName:function(c){var d=this.project.getAvailableResources();for(var b=0;b<d.length;b++){if(d[b].id===c){return d[b].Name}}},onOkTaskButtonClick:function(b){if(window.currentViewId=="matrix"&&this.$el.hasClass("task-zoom-normal")){this.onTaskZoomClick(b)}else{this.exitQuickEditMode();b.stopPropagation();if(window.currentViewId=="timeline"){this.$el.hide();Ext.getCmp("timelineview").stopEditingTask();if(Ext.getBody().isMasked()){Ext.getBody().unmask()}if(this.$el.hasClass("task-zoom-normal")){if(stl.app.handlerPtr!=null){window.removeEventListener("paste",stl.app.handlerPtr);stl.app.handlerPtr=null}}}}},onDeleteTaskButtonClick:function(b){$(b.target).closest(".phase-type-fullkit").removeClass("has-task");$(this).trigger("delete",[b])},onDeleteSubTaskButtonClick:function(c){if(this.readOnly){return}c.stopPropagation();var e=this,b=$(c.target),h=b.closest("li"),g=h.data("model"),d=this.$el.data("model"),f=this.$el;h.remove();e.saveSubtasks(this.$el);this.project.reCalculateSubTaskStartDate(d);this.updateWIPLimitNotification(d,f);$(this).trigger("deletesubtask",[g,d])},onSubtaskStatusClick:function(b){if(this.readOnly){return}var c=this,g=$(b.target).closest("li"),f=g.data("model");var e=this.$el;var d=this.task.subtaskType;if(d==SubtaskTypesEnum.WIP){this.showPromptIfWIPLimitExceeded(e,g,f,this.task)}else{c.saveSubtaskStatusAndShowValidation(g,f)}},saveSubtaskStatusAndShowValidation:function(h,g){var e=this;var f=this.task.subtaskType;var d=this.completeSubtaskOnChecklistComplete?(g.checklistStatus==2||g.checklistStatus==0):true;var c="NS";var b=g.status;if(b=="0"){b="NS"}else{if(b=="1"){b="IP"}else{if(b=="2"){b="CO"}}}switch(g.status){case"0":case"NS":if(f==SubtaskTypesEnum.VOLUME){if(d){g.status="CO"}else{PPI_Notifier.info(SUBTASK_CANNOT_MARKED_COMPLETE)}}else{g.status="IP"}break;case"1":case"IP":if(d){g.status="CO"}else{PPI_Notifier.info(SUBTASK_CANNOT_MARKED_COMPLETE)}break;case"2":case"CO":g.status="NS";break}this.setDurationAndDatesForSubtask(g,h);this.subtaskStatusChangeValidations(b,g.status,g,this.task,h,function(){e.$el.trigger("rollupDurationChange");e.refreshSubtaskStatus(h);e.saveSubtask(h)})},showPromptIfWIPLimitExceeded:function(f,e,b,c){var d=this;if(b.status=="NS"&&d.project.isWIPLimitExceeded(c,STATUS_IP)){if(!d.isWIPExceededImageVisible(f)){PPI_Notifier.confirm(WIP_LIMIT_EXCEEDED_ALERT_MESG,WIP_LIMIT_EXCEEDED_TITLE,function(){d.showWIPExceededImg(f);d.saveSubtaskStatusAndShowValidation(e,b)},function(){d.refreshSubtaskStatus(e)})}else{d.saveSubtaskStatusAndShowValidation(e,b)}}else{d.saveSubtaskStatusAndShowValidation(e,b);if(!d.project.isWIPLimitExceeded(c,b.status)){d.hideWIPExceededImg(f)}}},showWIPExceededImg:function(c){var b=$(c).find(".imgWIP");if(b){b.show()}},hideWIPExceededImg:function(c){var b=$(c).find(".imgWIP");if(b){b.hide()}},isWIPExceededImageVisible:function(d){var b=false;var c=$(d).find(".imgWIP");if(c){b=c.is(":visible")}return b},updateWIPLimitNotification:function(b,d){var c=this;if(c.hasWIPLimitExceeded(b)){c.showWIPExceededImg(d)}else{c.hideWIPExceededImg(d)}},hasWIPLimitExceeded:function(d){var f=this;var g=false;var c=d.subtasks;var b=d.subtasksWIPLimit;var e=0;e=_.filter(c,function(i,h){return i.status==STATUS_IP}).length;if(e>b){g=true}return g},setDurationAndDatesForSubtask:function(b,c){switch(b.status){case"2":case"CO":b.endDate=ServerClientDateClass.getTodaysDate();b.duration=SUBTASK_DURATION_DEFAULT;b.remainingDuration=0;b.actualStartDate=b.actualStartDate?b.actualStartDate:ServerClientDateClass.getTodaysDate();b.actualFinishDate=ServerClientDateClass.getTodaysDate();c.find(".subtask-duration input").val(ValidationClassInstance.getValidDurationString(b.remainingDuration,SUBTASK_DURATION_DEFAULT_STR,false));break;case"1":case"IP":b.actualStartDate=ServerClientDateClass.getTodaysDate();b.actualFinishDate=null;b.remainingDuration=b.remainingDuration==0?SUBTASK_DURATION_DEFAULT_SEC:b.remainingDuration;c.find(".subtask-duration input").val(ValidationClassInstance.getValidDurationString(b.remainingDuration,SUBTASK_DURATION_DEFAULT_STR,false));break;case"0":case"NS":b.actualStartDate=null;b.actualFinishDate=null;b.remainingDuration=b.remainingDuration==0?SUBTASK_DURATION_DEFAULT_SEC:b.remainingDuration;b.duration=b.remainingDuration;c.find(".subtask-duration input").val(ValidationClassInstance.getValidDurationString(b.remainingDuration,SUBTASK_DURATION_DEFAULT_STR,false))}},removeReleasedOptionFromTaskStatus:function(b){b.find(".task-status select option[value = 'RL']").remove()},removeHiddenSubtaskTypeOption:function(f,d){var e=this;var c=d.subtaskType;var b=f.find(".subtask-type select");_.each(SubtaskTypesEnum,function(i,g,h){if(e.project.isSubtaskTypeOptionHidden(c,i)){var j=b.find("option[value = '"+i+"']");if(j){j.remove()}}})},removeIPOptionFromTaskStatus:function(b){b.find(".task-status select option[value = 'IP']").remove()},appendIPOptionForTaskStatus:function(b){if(b.find(".task-status select option[value = 'IP']").length===0){b.find(".task-status select option[value = 'CO']").before('<option  data-resx-key = "IN_PROGRESS_Key"  value="IP">In progress</option>')}},bindTaskTypeSpecificProperties:function(d){var g=this.$el,f=this.task;g.find(".task-specific-properties").hide();g.find(".task-specific-properties-"+f.taskType).css("display","inline-block");switch(f.taskType){case"normal":this.showSubtasksRegion(g);if(g.hasClass("purchasingTask")){g.removeClass("purchasingTask")}this.removeReleasedOptionFromTaskStatus(g);break;case"fullkit":this.initializeExpectedFinishDateField(g);var b=g.find(".fullkit-name");if(b.length===0){b=$('<div class="fullkit-name"></div>');g.find(".task-name").append(b)}var e=g.find(".fullkit-color");if(e.length===0){$fullkitColor=$('<div class="fullkit-color"></div>');g.append($fullkitColor)}var c="FK";b.text(c);if(g.hasClass("purchasingTask")){g.removeClass("purchasingTask")}this.enableOrDisableExpectedFinishDate(g);this.enableOrDisablePullInDuration(g);break;case"purchasing":this.initializeExpectedFinishDateField(g);if(!g.hasClass("purchasingTask")){g.addClass("purchasingTask")}this.enableOrDisableExpectedFinishDate(g);this.removeReleasedOptionFromTaskStatus(g);break;case"snet":this.initializeSnetDateField(g);this.showSubtasksRegion(g);if(g.hasClass("purchasingTask")){g.removeClass("purchasingTask")}if(!f.startNoEarlierThan){f.startNoEarlierThan=ServerClientDateClass.getTodaysDate()}this.removeReleasedOptionFromTaskStatus(g);break}},initializeSnetDateField:function(c){var d=c.find(".snet input");var b=this.task;if(!this.initializedSnetDateField){d.datepicker({format:ServerTimeFormat.getBootstrapPickerDateFormat(),assumeNearByYear:true,autoclose:true,startDate:"-0d"}).on("keypress",function(e){if(e.which==13){e.preventDefault()}}).on("changeDate",this.onSNETChange.bind(this)).on("hide",function(f){if(!f.date){this.$el.find(".snet input").datepicker("setDate",ServerTimeFormat.getDateInLocaleFormat(this.task.startNoEarlierThan))}}.bind(this));this.initializedSnetDateField=true}if(b.startNoEarlierThan){d.datepicker("setDate",ServerTimeFormat.getDateInLocaleFormat(b.startNoEarlierThan))}else{d.datepicker("setDate",ServerTimeFormat.getTodaysDateInLocaleFormat())}},initializeExpectedFinishDateField:function(d){var c=d.find(".expectedFinishDate input");var b=this.task;if(!this.initializedExpectedFinishDateField){c.datepicker({format:ServerTimeFormat.getBootstrapPickerDateFormat(),assumeNearByYear:true,autoclose:true,startDate:"-0d"}).on("keypress",function(e){if(e.which==13){e.preventDefault()}}).on("changeDate",this.onExpectedFinishDateChange.bind(this)).on("hide",function(f){if(!f.date){this.$el.find(".expectedFinishDate input").datepicker("setDate",ServerTimeFormat.getDateInLocaleFormat(this.task.date7))}}.bind(this));this.initializedExpectedFinishDateField=true}if(b.date7){c.datepicker("setDate",ServerTimeFormat.getDateInLocaleFormat(b.date7))}else{c.datepicker("setDate",ServerTimeFormat.getTodaysDateInLocaleFormat())}},onFullkitTaskClick:function(b){var c=stl.app.isProjectOpenInViewOnlyMode();if(c){return}$(".tool-popup").hide();$(b.target).closest(".task").find(".tool-popup").show();b.stopPropagation()},bindSubtaskTypeSpecificProperties:function(){var d=this.$el,c=this.task;d.find(".subtask-specific-property").hide();var b=d.find(".subtask-specific-property-"+this.getSubtaskTypeString(c.subtaskType));this.showHideSubtaskColumnsBySubtaskType(d,c);this.removeHiddenSubtaskTypeOption(d,c);if(this.task.subtaskType==SubtaskTypesEnum.VOLUME){d.addClass("subtask-type-rate")}else{if(this.task.subtaskType==SubtaskTypesEnum.WIP){d.find(".WIP_Limit_textbox").show()}else{d.find(".WIP_Limit_textbox").hide();d.removeClass("subtask-type-rate")}}},getSubtaskTypeString:function(b){switch(b){case SubtaskTypesEnum.SEQUENTIAL:return"sequential";break;case SubtaskTypesEnum.VOLUME:return"volume";break;case SubtaskTypesEnum.WIP:return"wip";break;case SubtaskTypesEnum.PARALLEL:return"resource";break}},showHideSubtaskColumnsBySubtaskType:function(){},modifyTaskColor:function(f,b){var e=this.$el;var c=stl.app.getCurrentHighLightOption();switch(c){case RESOURCES:this.updateTaskResourceColors();break;case PHASES:if(b==1){var d=this.project.getPhaseColorMap()[this.project.getPhaseById(f).name];updateLegend(false,d,this.project.getPhaseById(f).name)}break;case TASK_MANAGERS:this.updateTaskManagerColors();break}},updateTaskResourceColors:function(){var c=this,d=this.getAvailableResourceOptions(),b=this.project.getResourceColorMap(),e=this.$el;e.attr("class").split(/\s+/).forEach(function(f){if(f.indexOf("has-resource-")===0){e.removeClass(f)}if(f.indexOf("highlight-resource-")===0){e.removeClass(f)}});this.task.resources.forEach(function(h){var g=b[h.resourceId];var f=stl.app.getCurrentHighLightOption();e.addClass("has-resource-"+h.resourceId);if((f===RESOURCES)&&g){if(g&&$(".highlight-resources-popup .tool-item:eq("+(g)+")").find("input").is(":checked")){e.addClass("highlight-resource-"+g);updateLegend(true,g,$(".highlight-resources-popup .tool-item:eq("+(g)+")").find(".resource-name").text())}}})},updateTaskPhaseColors:function(){delete this.project._phaseColorMap;var h=this,c=this.project.phases,e=this.project.getPhaseColorMap(),b=this.$el;b.attr("class").split(/\s+/).forEach(function(k){if(k.indexOf("has-phase-")===0){b.removeClass(k)}if(k.indexOf("highlight-phase-")===0){b.removeClass(k)}});var g=e[this.project.getPhaseById(this.task.phaseId).name];if(g){b.addClass("has-phase-"+stringToHex(this.project.getPhaseById(this.task.phaseId).name.replace(/ /g,"")));b.addClass("has-phase-"+stringToHex(this.task.phaseId))}var i=stl.app.getCurrentHighLightOption();if((i===PHASES)&&g&&$(".highlight-phases-popup .tool-item:eq("+(g)+")").find("input").is(":checked")){b.addClass("highlight-phase-"+g);var d=b.closest(".phase-column").parent().parent(),j=d.find(".task.has-phase-"+stringToHex(this.task.phaseId)),f=j.length;if(f===1){updateLegend(true,g,this.project.getPhaseById(this.task.phaseId).name)}}},updateTaskManagerColors:function(){var f=this,d=DataStore.ProjectManagerList,e=this.project.getTaskManagerColorMap(),g=this.$el;g.attr("class").split(/\s+/).forEach(function(h){if(h.indexOf("has-task-manager-")===0){g.removeClass(h)}if(h.indexOf("highlight-task-manager-")===0){g.removeClass(h)}});var c=e[this.task.manager];if(c){g.addClass("has-task-manager-"+stringToHex(this.task.manager.replace(/ /g,"")))}var b=stl.app.getCurrentHighLightOption();if((b===TASK_MANAGERS)&&c&&$(".highlight-task-managers-popup .tool-item:eq("+(c)+")").find("input").is(":checked")){g.addClass("highlight-task-manager-"+c);updateLegend(true,c,$(".highlight-task-managers-popup .tool-item:eq("+(c)+")").find(".task-manager-name").text())}},updateCCTaskColor:function(d,b){var d=this.$el,c=this.task;if(b.isCritical){d.addClass("isCCTask")}},getAvailableResourceOptions:function(){this.cachedAvailableResourceOptions=this.project.getAvailableResources().map(function(b){return{id:b.uid,text:b.Name}});this.cachedResourcesById=this.project.getAvailableResourcesByUid();return this.cachedAvailableResourceOptions},invalidateResourceCache:function(){delete this.cachedResourcesById;delete this.cachedAvailableResourceOptions;delete this.resourceHighlightMenuIsCurrent},getGlobalResourceObjWithUpdatedBaseCalendar:function(b){var c=jQuery.extend(true,{},b);c.BaseCalendarName=stl.app.ProjectDataFromServer.projectCalendarName;return c},getResourceObj:function(b){var c=jQuery.extend(true,{},b);return c},getResourceById:function(c){if(!this.cachedResourcesById){this.getAvailableResourceOptions()}var b;if(CalendarStore.GetInheritProjCalForResFlag()){b=this.getGlobalResourceObjWithUpdatedBaseCalendar(this.cachedResourcesById[c])}else{b=this.getResourceObj(this.cachedResourcesById[c])}return b},getAvailableManagerOptions:function(){if(!this.cachedAvailableManagerOptions){var b={};this.cachedAvailableManagerOptions=this.availablePeopleAndTeams.sort(function(d,c){return d.FullName.localeCompare(c.FullName)}).map(function(c){var d=c.Name;b[d]=c;return{id:d,text:c.FullName}});this.cachedManagersById=b}return this.cachedAvailableManagerOptions},checkConstrainingTask:function(c){var b=false;if(c&&$(c.currentTarget).find(".task").hasClass("constrainingSuccessorTask")){b=true}return b},checkResourceContentionTask:function(c){var b=false;if(c&&$(c.currentTarget).find(".task").hasClass("resourceContentionTask")){b=true}return b},checkSlackTask:function(b){var c=false;if(b&&$(b.currentTarget).find(".task").hasClass("slack")){c=true}return c},checkChainHighlightedTask:function(c){var d=false;var b=[];var e=[];if(c){if(c.currentTarget){e=c.currentTarget.classList}}_.each(e,function(g,f){if(g.indexOf("highlight-chain-")>-1){b.push(g)}});return b},enterQuickEditMode:function(e){if(this.insertBefore!==INSERT_TASK_BEFORE_TIMELINE_VIEW&&stl.app.matrixView&&stl.app.matrixView.zoomLevel>2){return}var f=this.$el;if(this.task.taskType==="fullkit"||this.project.checkIfZeroDurationTask(this.task)){f.after('<div class="task-spaceholder-fk"></div>')}else{f.after('<div class="task-spaceholder"></div>')}if(!this.initializedQuickEdit){this.initializeTaskQuickEditMode(f)}this.wasAlreadyFK=f.hasClass("fk");this.wasAlreadyZoomSmall=f.hasClass("task-zoom-small");if(this.task.taskType==="fullkit"){f.removeClass("fullkit");f.addClass("fk")}f.addClass("quick-task-edit task-zoom-small");if(f.find(".task-content-wrapper").width()<a){f.find(".task-content-wrapper").width(a)}var c=stl.app.getCurrentHighLightOption();var b;if(this.checkConstrainingTask(e)){f.addClass("constrainingSuccessorTask")}else{if(this.checkResourceContentionTask(e)){f.addClass("resourceContentionTask")}else{if(this.checkSlackTask(e)){f.addClass("slack")}else{if((b=this.checkChainHighlightedTask(e))&&b.length>0){f.addClass(b.join(" "))}}}}f.find(".subtask-type").hide();var d=f.find(".task-name-overflow-edit");d.text(f.find(".task-name input").val());if(!this.readOnly){d.focus();setTimeout(function(){range=document.createRange();range.selectNodeContents(d[0]);sel=window.getSelection();sel.removeAllRanges();sel.addRange(range)},0)}this.hideSubtasksRegion(f);this.processZeroDurationTask();$(this).trigger("enterquickedit")},initializeTaskQuickEditMode:function(d){var c=d.find(".task-status select");var b=this.task;if(!this.initializedQuickEdit){c.select2({dropdownAutoWidth:true,minimumResultsForSearch:-1}).on("change",this.onStatusDropdownChange.bind(this))}if(b.taskType===TASKTYPE_FULLKIT||b.taskType===TASKTYPE_PT){this.initializeExpectedFinishDateField(d)}c.select2("val",b.status);if(b.taskType===TASKTYPE_SNET){this.initializeSnetDateField(d)}this.initializedQuickEdit=true},exitQuickEditMode:function(){var b=this;var d=this.$el;d.next(".task-spaceholder, .task-spaceholder-fk").remove();d.removeClass("quick-task-edit");if(!this.wasAlreadyZoomSmall){d.removeClass("task-zoom-small")}if(this.task.taskType==="fullkit"&&!this.wasAlreadyFK){d.removeClass("fk");d.addClass("fullkit");d.addClass("task")}d.find(".task-name-overflow-edit").css("background","transparent");if(!b.readOnly){var e=d.find(".task-name-overflow-edit").text();if(e.trim()){d.find(".task-name input").val(e);d.data("linkable-element-name",e);b.saveNameField(e)}else{var c=d.data("model");d.find(".task-name-overflow-edit").text(c.name);PPI_Notifier.info(EMPTY_TASK_NAME_NOT_ALLOWED)}b.checkTaskForDefaultName(d)}if(stl.app.matrixView&&stl.app.matrixView.zoomLevel==0){d.find(".task-controls").css("display","")}this.processZeroDurationTask();$(this).trigger("exitquickedit");$(this).trigger("change");if(stl.app.matrixView&&this.refreshLinkForZeroDurationTask){stl.app.matrixView.refreshLinks()}},onClick:function(b){if(!$(b.target).hasClass("add-task-plus-icon")){var d=this,e=this.$el,c=this.task;if(this.readOnly){if(e.hasClass("task-zoom-normal")||e.hasClass("quick-task-edit")){return}d.enterQuickEditMode()}if(!this.readOnly&&!e.hasClass("quick-task-edit")&&!e.hasClass("task-zoom-normal")){if(stl.app.matrixView&&(stl.app.matrixView.zoomLevel!=3||c.taskType=="fullkit")){d.enterQuickEditMode()}e.find(".task-controls").css("display","inline")}}},wireSubTaskEvents:function(){var b=this;this.$el.find(".subtasks li .subtask-name input").on("focus",function(c){var e=$(c.target),d=e.closest("li");if(d.hasClass("proto-subtask")){e.val("");e.removeClass("placeholdersjs");if(!stl.app.isPasteExternalInitiated()){stl.app.initPasteExternalEvent(b.pasteSubtasksCallbk.bind(b))}}c.stopPropagation()});this.$el.find(".subtasks li .subtask-name input").on("keypress",function(c){if(c.which==13){c.preventDefault();var e=$(c.target),d=e.closest("li");if(d.hasClass("proto-subtask")&&e.val()!=EMPTY_STRING){b.renderNewSubtask(d,e.val(),true)}}c.stopPropagation()});this.$el.find(".subtasks li .subtask-name input").on("blur",function(d){var f=$(d.target),e=f.closest("li");if(e.hasClass("proto-subtask")&&f.val()!=EMPTY_STRING){b.renderNewSubtask(e,f.val(),false)}else{if(!e.hasClass("proto-subtask")&&f.val()!=EMPTY_STRING){$(this).closest("li").data("model").name=f.val()}else{if(!e.hasClass("proto-subtask")&&f.val()===EMPTY_STRING){var c=$(this).closest("li").data("model").name;$(this).val(c)}}}stl.app.removePasteEventListener();Placeholders.enable();d.stopPropagation()});this.$el.find(".subtasks li .subtask-checklist-icon").off().on("click",function(c){if(window.currentViewId=="timeline"){Ext.getCmp("timelineview").showChecklistPopupForSubtask($(c.target).closest("li"))}else{$(".matrix-view").data("view").showChecklistPopupForSubtask($(c.target).closest("li"))}c.stopPropagation()})},setDefaultSubtaskTypeAndWIPLimit:function(){this.task.subtaskType=stl.app.getDefaultSubtaskType();this.task.subtasksWIPLimit=stl.app.commonSettingValue("SUBTASKS_DEFAULT_WIP_LIMIT");this.$el.find("#task-subtask-type-select").select2("val",stl.app.getDefaultSubtaskType());this.$el.find("#task-wip-limt-txt").val(stl.app.commonSettingValue("SUBTASKS_DEFAULT_WIP_LIMIT"))},renderNewSubtask:function(f,e,c){var d=this,b=f.clone(true);if(d.task.subtaskCount===0){this.setDefaultSubtaskTypeAndWIPLimit();this.bindSubtaskTypeSpecificProperties()}f.parent().append(b);b.find("input[type=text]").val("");d.bindSubtask(f,d.project.createSubtask({name:e},d.$el.data("model")));f.removeClass("proto-subtask");f.closest(".subtasks ul").sortable("refresh");d.saveSubtasks(d.$el);d.$el.trigger("rollupDurationChange");if(c){f.next("li").find(".subtask-name input").focus()}},checkTaskForDefaultName:function(i){var e=i.data("model"),g=e.uid,c=$.grep(this.project.phases,function(j){return j.uid==e.phaseId})[0],h=$.grep(this.project.rows,function(j){return j.uid==e.rowId})[0],f=this.project.getScopeItemByUid(h.scopeItemUid);if(f){var b=f.name}var d=i.find(".task-name input").val();if(d!==""&&d.indexOf(this.project.getDefaultTaskNameCompareString(c.name,b))!==-1){i.addClass("has-default-name")}else{i.removeClass("has-default-name")}}})})());